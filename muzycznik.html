<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Śpiewnik - Wersja Edytowalna</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f4f4;
            --bg-sidebar: #ffffff;
            --bg-main: #ffffff;
            --bg-song-area: #ffffff;
            --text-main: #333;
            --text-song: #000000;
            --text-chords: #a0522d;
            --border-color: #ccc;
            --accent-success: #28a745;
            --accent-blue: #007bff;
            --lyrics-font-size: 18px;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-main: #181818;
            --bg-song-area: #181818;
            --text-main: #e0e0e0;
            --text-song: #ffffff;
            --text-chords: #ff9f43;
            --border-color: #444;
        }

        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; overflow: hidden; }
        #app-container { display: flex; height: 100vh; width: 100vw; position: relative; }
        
        #sidebar { 
            width: 320px; border-right: 1px solid var(--border-color); 
            background: var(--bg-sidebar); padding: 15px; display: flex; flex-direction: column;
            transition: transform 0.3s ease; z-index: 20;
        }

        #main-content { 
            flex-grow: 1; overflow-y: auto; background: var(--bg-main); 
            scroll-behavior: smooth; position: relative; z-index: 10;
            touch-action: pan-y;
        }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; box-sizing: border-box; }
            #main-content { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            body.song-active #main-content { transform: translateX(0); }
            body.song-active #sidebar { transform: translateX(-100%); }
            .mobile-only { display: inline-block !important; }
        }

        .mobile-only { display: none; }

        /* ZMIANA: Zwiększyłem flex-wrap, żeby kontrolki mieściły się na małych ekranach */
        #controls-bar { 
            display: flex; gap: 8px; padding: 10px; background: #eee; 
            border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 30; align-items: center;
            overflow-x: auto; /* Zabezpieczenie przed ucięciem */
        }
        body.dark-mode #controls-bar { background: #252525; border-color: #444; }

        .control-group {
            display: flex; align-items: center; gap: 5px; 
            background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 6px;
            white-space: nowrap;
        }

        #settings-menu {
            display: none; position: absolute; top: 55px; right: 10px; 
            background: var(--bg-sidebar); border: 1px solid var(--border-color);
            padding: 15px; border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.3);
            flex-direction: column; gap: 12px; min-width: 240px; z-index: 100;
        }
        #settings-menu.active { display: flex; }

        .setting-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .setting-item label { font-size: 13px; font-weight: bold; }

        #song-capture-area { padding: 25px; background: var(--bg-song-area); color: var(--text-song); min-height: 100%; }
        
        .chords-container { background: rgba(128,128,128,0.1); border: 1px solid var(--border-color); padding: 15px; margin: 15px 0; border-radius: 5px; }
        
        #active-chords-content { 
            font-family: 'Courier New', monospace; 
            font-size: calc(var(--lyrics-font-size) * 0.9);
            white-space: pre-wrap; margin: 0; color: var(--text-song); 
        }
        
        .lyrics-content { 
            white-space: pre-wrap; font-size: var(--lyrics-font-size); 
            line-height: 1.6; margin-top: 20px; color: var(--text-song); 
        }
        .inline-chord { font-weight: bold; color: var(--text-chords); }

        button { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-sidebar); color: var(--text-main); }
        .btn-green { background: var(--accent-success); color: white; border: none; }
        .btn-blue { background: var(--accent-blue); color: white; border: none; }
        .btn-icon { padding: 8px 10px; font-size: 18px; border: none; background: transparent; }

        #editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-sidebar); padding: 20px; border-radius: 8px; width: 95%; max-width: 500px; }
        
        #progress-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; z-index: 1100; flex-direction: column; align-items: center; justify-content: center; }
        #song-list { list-style: none; padding: 0; overflow-y: auto; flex-grow: 1; }
        #song-list li { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        #song-list li.selected { background: var(--accent-blue); color: white; }
    </style>
</head>
<body>

<div id="progress-overlay"><h2 id="progress-text">Przetwarzanie...</h2><p id="progress-count">0/0</p></div>

<div id="editor-modal">
    <div class="modal-content">
        <h3 id="editor-title">➕ Nowa piosenka</h3>
        <input type="text" id="edit-title" placeholder="Tytuł" style="width:100%; margin-bottom:10px; padding:8px;">
        <input type="text" id="edit-artist" placeholder="Wykonawca" style="width:100%; margin-bottom:10px; padding:8px;">
        <textarea id="edit-lyrics" placeholder="Tekst [C]z akordami..." style="width:100%; margin-bottom:10px; padding:8px; height:120px; font-family:monospace;"></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="closeEditor()" style="flex:1">Anuluj</button>
            <button id="btn-save-song" class="btn-green" onclick="saveSongData()" style="flex:1">Zapisz</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <select id="collection-select" style="width:100%; padding:10px; margin-bottom:10px; font-weight: bold;"></select>
        <input type="text" id="search" placeholder="Szukaj piosenki..." style="width:100%; padding:12px; box-sizing: border-box; margin-bottom:10px; border-radius: 20px; border: 1px solid var(--border-color);">
        <ul id="song-list"></ul>
    </div>

    <div id="main-content">
        <div id="controls-bar" style="display:none;">
            <button onclick="backToList()" class="mobile-only btn-icon"><i class="fas fa-arrow-left"></i></button>
            
            <div class="control-group">
                <button id="btn-transpose-down" class="btn-icon" style="font-size: 14px;"><i class="fas fa-minus"></i></button>
                <span id="transpose-val" style="font-weight:bold; min-width:25px; text-align:center;">0</span>
                <button id="btn-transpose-up" class="btn-icon" style="font-size: 14px;"><i class="fas fa-plus"></i></button>
                <button id="btn-transpose-reset" class="btn-icon" style="font-size: 14px; color: var(--accent-blue);"><i class="fas fa-redo"></i></button>
            </div>

            <div class="control-group" style="margin-left:5px;">
                <button id="btn-scroll-toggle" class="btn-icon" style="font-size: 16px;"><i class="fas fa-play"></i></button>
                <input type="range" id="scroll-speed" min="1" max="50" value="10" style="width:60px;" title="Prędkość">
            </div>

            <div style="flex-grow: 1;"></div>
            <button id="btn-settings" class="btn-icon"><i class="fas fa-cog"></i></button>
        </div>

        <div id="settings-menu">
            <div class="setting-item">
                <label><i class="fas fa-search-plus"></i> Rozmiar (2 palce)</label>
                <span id="font-size-val" style="font-size: 12px; font-weight: bold;">18px</span>
            </div>
            <input type="range" id="font-size-slider" min="12" max="60" value="18" style="width:100%;">
            <hr style="width:100%; opacity:0.1;">
            
            <div class="setting-item"><label>Akordy</label><button id="btn-toggle-chords" style="width: 80px;">Ukryj</button></div>
            <div class="setting-item"><label>Tryb nocny</label><button id="btn-dark-mode" class="btn-icon"><i class="fas fa-moon"></i></button></div>
            
            <hr style="width:100%; opacity:0.1;">
            
            <button onclick="startEditCurrent()" style="text-align:left; background: #ffc107; color: #000; border:none;"><i class="fas fa-edit"></i> Edytuj tę piosenkę</button>
            <button onclick="startNewSong()" style="text-align:left;"><i class="fas fa-plus-circle"></i> Dodaj nową piosenkę</button>
            
            <button id="btn-download-json" class="btn-blue" style="text-align:left;"><i class="fas fa-file-download"></i> Pobierz plik JSON</button>
            <button id="btn-export-all" class="btn-green" style="text-align:left;"><i class="fas fa-images"></i> Eksportuj wszystko (JPG)</button>
            <button id="btn-jpg" style="text-align:left; background: #666; color: white; border:none;"><i class="fas fa-image"></i> Pobierz tę piosenkę</button>
        </div>

        <div id="song-capture-area">
            <div id="song-display">
                <div style="padding:40px; text-align:center; color:#888;">Wybierz piosenkę.</div>
            </div>
        </div>
    </div>
</div>

<script>
    const COLLECTIONS = [{ name: "Główny Zbiór", file: 'piosenki.json' },{ name: "Kolędy", file: 'koledy.json' },{ name: "Inne", file: 'lukasz.json' }];
    let allSongs = [], currentId = null, transpose = 0, showChords = true;
    let scrollInterval = null, isScrolling = false;
    let currentFontSize = 18;
    // ZMIANA 3: Zmienna pomocnicza do śledzenia co edytujemy
    let editingId = null; 

    const scale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const dScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];

    const colSelect = document.getElementById('collection-select');
    COLLECTIONS.forEach(c => colSelect.add(new Option(c.name, c.file)));
    colSelect.onchange = (e) => loadSongs(e.target.value);

    async function loadSongs(file) {
        try {
            const response = await fetch(file);
            const data = await response.json();
            // ID generowane dynamicznie na podstawie czasu wczytania, aby uniknąć konfliktów przy edycji
            allSongs = data.map((s, index) => ({ ...s, id: Date.now() + index, searchKey: (s.title + " " + s.artist).toLowerCase() }));
            renderList();
        } catch (e) { console.error(e); }
    }

    function renderList() {
        const term = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('song-list');
        list.innerHTML = allSongs.filter(s => s.searchKey.includes(term)).sort((a,b)=>a.title.localeCompare(b.title)).map(s => `
            <li onclick="selectSong(${s.id})" class="${currentId === s.id ? 'selected' : ''}">${s.title}</li>
        `).join('');
    }

    function setFontSize(size) {
        currentFontSize = Math.min(Math.max(size, 12), 60);
        document.documentElement.style.setProperty('--lyrics-font-size', currentFontSize + 'px');
        document.getElementById('font-size-slider').value = currentFontSize;
        document.getElementById('font-size-val').textContent = currentFontSize + 'px';
    }

    // GEST LUPY (PINCH ZOOM)
    let initialDist = -1;
    const mainContent = document.getElementById('main-content');

    mainContent.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        }
    }, { passive: true });

    mainContent.addEventListener('touchmove', e => {
        if (e.touches.length === 2 && initialDist > 0) {
            e.preventDefault();
            const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            const diff = (dist - initialDist) / 10;
            setFontSize(currentFontSize + diff);
            initialDist = dist;
        }
    }, { passive: false });

    mainContent.addEventListener('touchend', () => { initialDist = -1; });

    window.selectSong = (id) => { 
        stopAutoScroll(); 
        currentId = id; 
        transpose = 0; 
        document.getElementById('controls-bar').style.display = "flex"; 
        document.body.classList.add('song-active'); 
        document.getElementById('settings-menu').classList.remove('active'); 
        updateView(); 
        renderList(); 
        mainContent.scrollTop = 0; 
    };

    function backToList() { stopAutoScroll(); document.body.classList.remove('song-active'); }
    document.getElementById('btn-settings').onclick = (e) => { e.stopPropagation(); document.getElementById('settings-menu').classList.toggle('active'); };
    document.addEventListener('click', () => document.getElementById('settings-menu').classList.remove('active'));
    document.getElementById('font-size-slider').oninput = (e) => setFontSize(parseInt(e.target.value));

    // Swipe Back
    let touchStartX = 0;
    document.addEventListener('touchstart', e => { if(e.touches.length === 1) touchStartX = e.touches[0].screenX; }, { passive: true });
    document.addEventListener('touchend', e => { if (e.touches.length === 0 && e.changedTouches[0].screenX - touchStartX > 100 && document.body.classList.contains('song-active')) backToList(); });

    function transChord(c, s) { return c.replace(/([A-GHa-gh][b#]?)([\w\d\/#\-]*)?/, (m, b, mod) => { let base = b.toUpperCase().replace('H', 'B'); let i = scale.indexOf(base); if (i === -1) return m; i = (i + s % 12 + 12) % 12; let res = dScale[i]; if (b === b.toLowerCase()) res = res.toLowerCase(); return res + (mod || ''); }); }
    
    function updateView() { 
        if (currentId === null) return; 
        const song = allSongs.find(s => s.id === currentId); 
        // Zabezpieczenie na wypadek usunięcia piosenki
        if (!song) return;
        document.getElementById('song-display').innerHTML = generateSongHTML(song, transpose, showChords); 
        document.getElementById('transpose-val').textContent = (transpose > 0 ? '+' : '') + transpose; 
    }
    
    document.getElementById('btn-toggle-chords').onclick = function() { showChords = !showChords; this.textContent = showChords ? "Ukryj" : "Pokaż"; updateView(); };
    
    function startAutoScroll() { isScrolling = true; document.getElementById('btn-scroll-toggle').innerHTML = '<i class="fas fa-pause"></i>'; scrollInterval = setInterval(() => { mainContent.scrollTop += 1; }, 55 - document.getElementById('scroll-speed').value); }
    function stopAutoScroll() { isScrolling = false; document.getElementById('btn-scroll-toggle').innerHTML = '<i class="fas fa-play"></i>'; clearInterval(scrollInterval); }
    
    // ZMIANA 3: Logika edycji i dodawania
    function startNewSong() {
        editingId = null;
        document.getElementById('editor-title').textContent = "➕ Nowa piosenka";
        document.getElementById('edit-title').value = "";
        document.getElementById('edit-artist').value = "";
        document.getElementById('edit-lyrics').value = "";
        document.getElementById('btn-save-song').textContent = "Dodaj";
        document.getElementById('editor-modal').style.display = 'flex';
    }

    function startEditCurrent() {
        if (currentId === null) return;
        const song = allSongs.find(s => s.id === currentId);
        if (!song) return;

        editingId = song.id;
        document.getElementById('editor-title').textContent = "✏️ Edytuj piosenkę";
        document.getElementById('edit-title').value = song.title;
        document.getElementById('edit-artist').value = song.artist || "";
        document.getElementById('edit-lyrics').value = song.lyrics || "";
        document.getElementById('btn-save-song').textContent = "Zapisz zmiany";
        document.getElementById('editor-modal').style.display = 'flex';
    }

    function closeEditor() { document.getElementById('editor-modal').style.display = 'none'; }

    function saveSongData() { 
        const title = document.getElementById('edit-title').value; 
        if (!title) return alert("Podaj tytuł!"); 
        
        const artist = document.getElementById('edit-artist').value;
        const lyrics = document.getElementById('edit-lyrics').value;
        const searchKey = (title + " " + artist).toLowerCase();

        if (editingId) {
            // Edycja istniejącej
            const index = allSongs.findIndex(s => s.id === editingId);
            if (index !== -1) {
                allSongs[index].title = title;
                allSongs[index].artist = artist;
                allSongs[index].lyrics = lyrics;
                allSongs[index].searchKey = searchKey;
                // Jeśli edytujemy aktualnie wyświetlaną, odśwież widok
                if (currentId === editingId) updateView();
            }
        } else {
            // Nowa piosenka
            const newId = Date.now();
            const newSong = { title, artist, lyrics, id: newId, searchKey }; 
            allSongs.push(newSong); 
            currentId = newId; // Przełącz na nową
            selectSong(newId);
        }
        
        renderList(); 
        closeEditor(); 
    }

    document.getElementById('btn-download-json').onclick = () => { const clean = allSongs.map(({title, artist, chords, lyrics}) => ({title, artist, chords, lyrics})); const blob = new Blob([JSON.stringify(clean, null, 2)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = colSelect.value; a.click(); };
    async function saveAsJpg(element, name) { element.style.width = "800px"; element.style.background = "#ffffff"; const canvas = await html2canvas(element, { scale: 2 }); const link = document.createElement('a'); link.download = name + ".jpg"; link.href = canvas.toDataURL("image/jpeg", 0.9); link.click(); element.style.width = ""; element.style.background = ""; }
    document.getElementById('btn-export-all').onclick = async function() { const overlay = document.getElementById('progress-overlay'); overlay.style.display = 'flex'; for (let i = 0; i < allSongs.length; i++) { document.getElementById('progress-count').textContent = `${i+1}/${allSongs.length}`; document.getElementById('song-display').innerHTML = generateSongHTML(allSongs[i], 0, true); await new Promise(r => setTimeout(r, 400)); await saveAsJpg(document.getElementById('song-capture-area'), allSongs[i].title); } overlay.style.display = 'none'; updateView(); };
    function generateSongHTML(song, trans, visible) { let html = `<h2>${song.title} <small style="opacity:0.7">(${song.artist})</small></h2>`; 
        // Wsparcie dla starych pól "chords" oraz połączonego tekstu z akordami
        let txt = song.lyrics || "";
        if (song.chords && visible) { const tc = song.chords.replace(/([A-GHa-gh][b#]?[\w\d\/#\-]*)/g, m => transChord(m, trans)); html += `<div class="chords-container"><pre id="active-chords-content">${tc}</pre></div>`; } 
        let lyr = txt.replace(/\[(.*?)\]/g, visible ? (m, c) => `<span class="inline-chord">${transChord(c, trans)}</span>` : ''); return html + `<div class="lyrics-content">${lyr}</div>`; }
    
    document.getElementById('btn-transpose-up').onclick = () => { transpose++; updateView(); };
    document.getElementById('btn-transpose-down').onclick = () => { transpose--; updateView(); };
    document.getElementById('btn-transpose-reset').onclick = () => { transpose = 0; updateView(); };
    document.getElementById('btn-scroll-toggle').onclick = () => isScrolling ? stopAutoScroll() : startAutoScroll();
    document.getElementById('btn-jpg').onclick = () => saveAsJpg(document.getElementById('song-capture-area'), allSongs.find(s=>s.id===currentId).title);
    document.getElementById('btn-dark-mode').onclick = () => document.body.classList.toggle('dark-mode');
    document.getElementById('search').oninput = renderList;
    loadSongs(COLLECTIONS[0].file);
</script>
</body>
</html>
