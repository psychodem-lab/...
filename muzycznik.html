<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Śpiewnik - Edytor Bazy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f4f4;
            --bg-sidebar: #ffffff;
            --bg-main: #ffffff;
            --bg-song-area: #ffffff;
            --text-main: #333;
            --text-song: #000000;
            --text-chords: #a0522d;
            --border-color: #ccc;
            --accent-success: #28a745;
            --accent-blue: #007bff;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-main: #181818;
            --bg-song-area: #181818;
            --text-main: #e0e0e0;
            --text-song: #ffffff;
            --text-chords: #ff9f43;
            --border-color: #444;
        }

        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; }
        #app-container { display: flex; height: 100vh; }
        
        #sidebar { width: 320px; border-right: 1px solid var(--border-color); background: var(--bg-sidebar); padding: 15px; display: flex; flex-direction: column; }
        #main-content { flex-grow: 1; overflow-y: auto; background: var(--bg-main); scroll-behavior: smooth; position: relative; }

        .header-select { margin-bottom: 15px; }
        .header-select select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-sidebar); color: var(--text-main); }

        #song-list { list-style: none; padding: 0; overflow-y: auto; flex-grow: 1; margin-top: 10px; }
        #song-list li { padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 14px; }
        #song-list li:hover { background: rgba(0,0,0,0.05); }
        #song-list li.selected { background: var(--border-color); font-weight: bold; }

        #controls-bar { display: flex; gap: 10px; padding: 10px; background: #eee; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 10; align-items: center; }
        body.dark-mode #controls-bar { background: #252525; color: #eee; }

        #song-capture-area { padding: 40px; background: var(--bg-song-area); color: var(--text-song); min-height: 100%; }
        
        .export-mode { width: 800px !important; color: #000 !important; background: #fff !important; }
        .export-mode #active-chords-content, .export-mode .lyrics-content { color: #000 !important; }

        .chords-container { background: rgba(128,128,128,0.1); border: 1px solid var(--border-color); padding: 15px; margin: 15px 0; border-radius: 5px; }
        #active-chords-content { font-family: 'Courier New', monospace; font-size: 16px; white-space: pre-wrap; margin: 0; color: var(--text-song); }
        .lyrics-content { white-space: pre-wrap; font-size: 19px; line-height: 1.6; margin-top: 20px; color: var(--text-song); }
        .inline-chord { font-weight: bold; color: var(--text-chords); }

        button { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-sidebar); color: var(--text-main); }
        .btn-green { background: var(--accent-success); color: white; border: none; }
        .btn-blue { background: var(--accent-blue); color: white; border: none; }
        
        .scroll-control { display: flex; align-items: center; gap: 5px; border-left: 1px solid var(--border-color); padding-left: 10px; }
        #scroll-speed { width: 60px; }

        /* MODAL (Okno edytora) */
        #editor-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; 
        }
        .modal-content { 
            background: var(--bg-sidebar); padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; 
            max-height: 90vh; overflow-y: auto; color: var(--text-main);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); }
        .form-group textarea { height: 150px; font-family: monospace; }

        #progress-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; z-index: 1100; flex-direction: column; align-items: center; justify-content: center; }
        .placeholder { padding: 40px; text-align: center; color: #888; }
    </style>
</head>
<body>

<div id="progress-overlay">
    <h2 id="progress-text">Przetwarzanie...</h2>
    <p id="progress-count">0 / 0</p>
</div>

<div id="editor-modal">
    <div class="modal-content">
        <h3>➕ Dodaj nową piosenkę</h3>
        <div class="form-group">
            <label>Tytuł:</label>
            <input type="text" id="edit-title" placeholder="np. Zawsze tam gdzie Ty">
        </div>
        <div class="form-group">
            <label>Wykonawca:</label>
            <input type="text" id="edit-artist" placeholder="np. Lady Pank">
        </div>
        <div class="form-group">
            <label>Akordy główne (opcjonalne):</label>
            <input type="text" id="edit-chords-top" placeholder="np. E fis A H">
        </div>
        <div class="form-group">
            <label>Tekst (używaj [C] dla akordów wewnątrz):</label>
            <textarea id="edit-lyrics" placeholder="[E]Zamknij oczy [fis]poczuć chciej..."></textarea>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeEditor()">Anuluj</button>
            <button class="btn-green" onclick="saveNewSong()">Dodaj do listy</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="header-select">
            <label style="font-size: 11px; font-weight: bold;">ZBIÓR:</label>
            <select id="collection-select"></select>
        </div>
        <input type="text" id="search" placeholder="Szukaj..." style="width:100%; padding:8px; box-sizing: border-box; margin-bottom: 5px;">
        
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button onclick="openEditor()" style="flex: 1; font-size: 12px;"><i class="fas fa-plus"></i> Nowa</button>
            <button id="btn-download-json" class="btn-blue" title="Pobierz aktualny plik JSON" style="flex: 1; font-size: 12px;"><i class="fas fa-save"></i> Eksport JSON</button>
        </div>

        <ul id="song-list"></ul>
        
        <div style="margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
            <button id="btn-export-all" class="btn-green" style="width:100%;"><i class="fas fa-file-export"></i> Eksportuj JPG</button>
        </div>
    </div>

    <div id="main-content">
        <div id="controls-bar" style="display:none;">
            <button id="btn-transpose-down"><i class="fas fa-minus"></i></button>
            <span id="transpose-val" style="min-width: 30px; text-align: center; font-weight: bold;">0</span>
            <button id="btn-transpose-reset" title="Resetuj"><i class="fas fa-redo"></i></button>
            <button id="btn-transpose-up"><i class="fas fa-plus"></i></button>
            <button id="btn-toggle-chords">Akordy</button>
            <div class="scroll-control">
                <button id="btn-scroll-toggle"><i class="fas fa-play"></i></button>
                <input type="range" id="scroll-speed" min="1" max="50" value="10">
            </div>
            <button id="btn-jpg" class="btn-green"><i class="fas fa-image"></i></button>
            <button id="btn-dark-mode"><i class="fas fa-moon"></i></button>
        </div>

        <div id="song-capture-area">
            <div id="song-display">
                <div class="placeholder">Wybierz piosenkę z listy.</div>
            </div>
        </div>
    </div>
</div>

<script>
    const COLLECTIONS = [
        { name: "Główny Zbiór", file: 'piosenki.json' },
        { name: "Kolędy", file: 'koledy.json' },
        { name: "Inne", file: 'lukasz.json' }
    ];

    let allSongs = [], currentId = null, transpose = 0, showChords = true;
    let scrollInterval = null, isScrolling = false;
    const scale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const dScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];

    const colSelect = document.getElementById('collection-select');
    COLLECTIONS.forEach(c => colSelect.add(new Option(c.name, c.file)));

    async function loadSongs(file) {
        try {
            const response = await fetch(file);
            const data = await response.json();
            allSongs = data.map((s, index) => ({ ...s, id: index, searchKey: (s.title + " " + s.artist).toLowerCase() }));
            renderList();
        } catch (e) { alert("Nie znaleziono pliku JSON. Upewnij się, że plik istnieje."); }
    }

    function renderList() {
        const term = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('song-list');
        list.innerHTML = allSongs.filter(s => s.searchKey.includes(term)).sort((a,b)=>a.title.localeCompare(b.title)).map(s => `
            <li onclick="selectSong(${s.id})" class="${currentId === s.id ? 'selected' : ''}">${s.title}</li>
        `).join('');
    }

    function transChord(c, s) {
        return c.replace(/([A-GHa-gh][b#]?)([\w\d\/#\-]*)?/, (m, b, mod) => {
            let base = b.toUpperCase().replace('H', 'B');
            let i = scale.indexOf(base);
            if (i === -1) return m;
            i = (i + s % 12 + 12) % 12;
            let res = dScale[i];
            if (b === b.toLowerCase()) res = res.toLowerCase();
            return res + (mod || '');
        });
    }

    function updateView() {
        if (currentId === null) return;
        const song = allSongs.find(s => s.id === currentId);
        document.getElementById('song-display').innerHTML = generateSongHTML(song, transpose, showChords);
        document.getElementById('transpose-val').textContent = (transpose > 0 ? '+' : '') + transpose;
    }

    window.selectSong = (id) => {
        stopAutoScroll();
        currentId = id; transpose = 0;
        document.getElementById('controls-bar').style.display = "flex";
        updateView(); renderList();
        document.getElementById('main-content').scrollTop = 0;
    };

    // --- EDYTOR I EKSPORT JSON ---
    function openEditor() { document.getElementById('editor-modal').style.display = 'flex'; }
    function closeEditor() { document.getElementById('editor-modal').style.display = 'none'; }

    function saveNewSong() {
        const title = document.getElementById('edit-title').value;
        const artist = document.getElementById('edit-artist').value;
        if (!title) return alert("Podaj tytuł!");

        const newSong = {
            id: Date.now(), // Unikalne ID czasowe
            title: title,
            artist: artist || "Nieznany",
            chords: document.getElementById('edit-chords-top').value,
            lyrics: document.getElementById('edit-lyrics').value,
            searchKey: (title + " " + artist).toLowerCase()
        };

        allSongs.push(newSong);
        renderList();
        closeEditor();
        selectSong(newSong.id);
        alert("Dodano piosenkę do widoku! Pamiętaj, aby pobrać nowy JSON, by zapisać ją na stałe.");
    }

    document.getElementById('btn-download-json').onclick = () => {
        // Czyścimy dane z technicznych pól przed eksportem
        const cleanData = allSongs.map(({title, artist, chords, lyrics}) => ({title, artist, chords, lyrics}));
        const blob = new Blob([JSON.stringify(cleanData, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = colSelect.value; // Pobiera jako nazwę aktualnie otwartego zbioru
        a.click();
    };

    // --- AUTO SCROLL ---
    function startAutoScroll() {
        isScrolling = true;
        document.getElementById('btn-scroll-toggle').innerHTML = '<i class="fas fa-pause"></i>';
        const container = document.getElementById('main-content');
        scrollInterval = setInterval(() => {
            container.scrollTop += 1;
            if (container.scrollTop + container.clientHeight >= container.scrollHeight) stopAutoScroll();
        }, 100 - document.getElementById('scroll-speed').value);
    }
    function stopAutoScroll() {
        isScrolling = false;
        document.getElementById('btn-scroll-toggle').innerHTML = '<i class="fas fa-play"></i>';
        clearInterval(scrollInterval);
    }

    // --- JPG EXPORT ---
    async function saveAsJpg(element, name) {
        element.classList.add('export-mode');
        await new Promise(r => setTimeout(r, 50));
        const canvas = await html2canvas(element, { backgroundColor: "#ffffff", scale: 2 });
        const link = document.createElement('a');
        link.download = name.replace(/[<>:"/\\|?*]/g, '') + ".jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        link.click();
        element.classList.remove('export-mode');
    }

    document.getElementById('btn-export-all').onclick = async function() {
        if (!allSongs.length) return;
        const overlay = document.getElementById('progress-overlay');
        overlay.style.display = 'flex';
        const display = document.getElementById('song-display');
        for (let i = 0; i < allSongs.length; i++) {
            const s = allSongs[i];
            document.getElementById('progress-count').textContent = `${i+1}/${allSongs.length}`;
            display.innerHTML = generateSongHTML(s, 0, showChords);
            await new Promise(r => setTimeout(r, 400));
            await saveAsJpg(document.getElementById('song-capture-area'), s.title);
        }
        overlay.style.display = 'none';
        updateView();
    };

    function generateSongHTML(song, trans, visible) {
        let html = `<h2>${song.title} <small style="opacity:0.7">(${song.artist})</small></h2>`;
        if (visible && song.chords) {
            const tc = song.chords.replace(/([A-GHa-gh][b#]?[\w\d\/#\-]*)/g, m => transChord(m, trans));
            html += `<div class="chords-container"><pre id="active-chords-content">${tc}</pre></div>`;
        }
        let lyr = (song.lyrics || "").replace(/\[(.*?)\]/g, visible ? (m, c) => `<span class="inline-chord">${transChord(c, trans)}</span>` : '');
        if (!visible) lyr = lyr.replace(/^\s*[\r\n]/gm, '');
        return html + `<div class="lyrics-content">${lyr}</div>`;
    }

    // Eventy
    document.getElementById('btn-transpose-up').onclick = () => { transpose++; updateView(); };
    document.getElementById('btn-transpose-down').onclick = () => { transpose--; updateView(); };
    document.getElementById('btn-transpose-reset').onclick = () => { transpose = 0; updateView(); };
    document.getElementById('btn-scroll-toggle').onclick = () => isScrolling ? stopAutoScroll() : startAutoScroll();
    document.getElementById('btn-toggle-chords').onclick = function() { showChords = !showChords; updateView(); };
    document.getElementById('btn-jpg').onclick = () => saveAsJpg(document.getElementById('song-capture-area'), allSongs.find(s=>s.id===currentId).title);
    document.getElementById('btn-dark-mode').onclick = () => { document.body.classList.toggle('dark-mode'); };
    document.getElementById('search').oninput = renderList;
    colSelect.onchange = (e) => loadSongs(e.target.value);

    loadSongs(COLLECTIONS[0].file);
</script>
</body>
</html>
