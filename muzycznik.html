<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Śpiewnik Pro - 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f4f4; --bg-sidebar: #ffffff; --bg-main: #ffffff;
            --text-main: #333; --text-song: #000000; --text-chords: #a0522d;
            --border-color: #ccc; --accent-blue: #007bff; --lyrics-font-size: 18px;
        }
        body.dark-mode {
            --bg-body: #121212; --bg-sidebar: #1e1e1e; --bg-main: #181818;
            --text-main: #e0e0e0; --text-song: #ffffff; --text-chords: #ff9f43; --border-color: #444;
        }
        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }
        #app-container { display: flex; height: 100vh; width: 100vw; }
        #sidebar { width: 320px; border-right: 1px solid var(--border-color); background: var(--bg-sidebar); padding: 15px; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 20; }
        #main-content { flex-grow: 1; overflow-y: auto; background: var(--bg-main); position: relative; z-index: 10; touch-action: pan-y; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; box-sizing: border-box; }
            #main-content { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            body.song-active #main-content { transform: translateX(0); }
            body.song-active #sidebar { transform: translateX(-100%); }
            .mobile-only { display: inline-block !important; }
        }
        .mobile-only { display: none; }

        #controls-bar { display: flex; gap: 8px; padding: 10px; background: #eee; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 30; align-items: center; flex-wrap: wrap; }
        body.dark-mode #controls-bar { background: #252525; border-color: #444; }
        .control-group { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 6px; }

        #settings-menu { display: none; position: absolute; top: 55px; right: 10px; background: var(--bg-sidebar); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); flex-direction: column; gap: 10px; min-width: 250px; z-index: 100; }
        #settings-menu.active { display: flex; }

        #song-display { padding: 25px; }
        .inline-chord { font-weight: bold; color: var(--text-chords); cursor: pointer; border-bottom: 1px dashed transparent; }
        .inline-chord:hover { border-bottom-color: var(--text-chords); }

        #song-list li { padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #song-list li.selected { background: var(--accent-blue); color: white; }
        .fav-star { color: #ccc; transition: 0.2s; padding: 5px; }
        .fav-star.active { color: #ffc107; }

        #editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-sidebar); padding: 20px; border-radius: 8px; width: 95%; max-width: 500px; }
        
        button { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-sidebar); color: var(--text-main); }
        .btn-icon { border: none; background: transparent; font-size: 18px; }

        /* Styl podpowiedzi akordów */
        #chord-tooltip { position: fixed; display: none; background: white; border: 2px solid #333; border-radius: 8px; padding: 10px; z-index: 2000; color: black; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="chord-tooltip"></div>

<div id="editor-modal">
    <div class="modal-content">
        <h3 id="editor-title">➕ Nowa piosenka</h3>
        <input type="text" id="edit-title" placeholder="Tytuł" style="width:100%; margin-bottom:10px; padding:8px;">
        <input type="text" id="edit-artist" placeholder="Wykonawca" style="width:100%; margin-bottom:10px; padding:8px;">
        <textarea id="edit-lyrics" placeholder="Tekst [C]z akordami..." style="width:100%; margin-bottom:10px; padding:8px; height:120px; font-family:monospace;"></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="closeEditor()" style="flex:1">Anuluj</button>
            <button class="btn-green" onclick="saveSongData()" style="flex:1; background: #28a745; color:white;">Zapisz</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <select id="collection-select" style="width:100%; padding:10px; margin-bottom:10px; font-weight: bold;">
            <option value="favorites">⭐ Ulubione</option>
        </select>
        <input type="text" id="search" placeholder="Szukaj..." style="width:100%; padding:12px; box-sizing: border-box; margin-bottom:10px; border-radius: 20px; border: 1px solid var(--border-color);">
        <ul id="song-list"></ul>
    </div>

    <div id="main-content">
        <div id="controls-bar" style="display:none;">
            <button onclick="backToList()" class="mobile-only btn-icon"><i class="fas fa-arrow-left"></i></button>
            
            <div class="control-group">
                <button onclick="changeTrans(-1)" class="btn-icon"><i class="fas fa-minus"></i></button>
                <span id="transpose-val" style="font-weight:bold; min-width:20px; text-align:center;">0</span>
                <button onclick="changeTrans(1)" class="btn-icon"><i class="fas fa-plus"></i></button>
            </div>

            <div class="control-group">
                <button id="btn-scroll-toggle" onclick="toggleScroll()" class="btn-icon"><i class="fas fa-play"></i></button>
                <input type="range" id="scroll-speed" min="1" max="50" value="10" style="width:50px;">
            </div>

            <div class="control-group">
                <button id="btn-metro-toggle" onclick="toggleMetronome()" class="btn-icon"><i class="fas fa-drum"></i></button>
                <input type="number" id="metro-bpm" value="120" style="width:45px; border:none; background:transparent; font-weight:bold; color:inherit;">
            </div>

            <div style="flex-grow: 1;"></div>
            <button id="btn-settings" class="btn-icon"><i class="fas fa-cog"></i></button>
        </div>

        <div id="settings-menu">
            <button onclick="startEditCurrent()"><i class="fas fa-edit"></i> Edytuj piosenkę</button>
            <button onclick="startNewSong()"><i class="fas fa-plus"></i> Dodaj nową</button>
            <hr style="width:100%; opacity:0.1;">
            <button onclick="document.getElementById('import-file').click()"><i class="fas fa-file-import"></i> Importuj JSON</button>
            <input type="file" id="import-file" style="display:none" onchange="importJSON(this)">
            <button id="btn-download-json"><i class="fas fa-file-download"></i> Pobierz JSON</button>
            <button id="btn-dark-mode"><i class="fas fa-moon"></i> Tryb nocny</button>
        </div>

        <div id="song-display">
            <div style="padding:40px; text-align:center; color:#888;">Wybierz piosenkę.</div>
        </div>
    </div>
</div>

<script>
    const COLLECTIONS = [{ name: "Główny Zbiór", file: 'piosenki.json' },{ name: "Kolędy", file: 'koledy.json' }];
    let allSongs = [], currentId = null, transpose = 0, favorites = JSON.parse(localStorage.getItem('favSongs') || '[]');
    let scrollInterval = null, isScrolling = false;
    let metroInterval = null, isMetroActive = false;
    let wakeLock = null;

    // Inicjalizacja menu kolekcji
    const colSelect = document.getElementById('collection-select');
    COLLECTIONS.forEach(c => colSelect.add(new Option(c.name, c.file)));
    colSelect.onchange = (e) => e.target.value === 'favorites' ? renderList() : loadSongs(e.target.value);

    async function loadSongs(file) {
        try {
            const response = await fetch(file);
            const data = await response.json();
            allSongs = data.map((s, i) => ({ ...s, id: "s" + i, searchKey: (s.title + " " + s.artist).toLowerCase() }));
            renderList();
        } catch (e) { console.error(e); }
    }

    // Usprawnienie 4: Obsługa Ulubionych
    function toggleFav(e, id) {
        e.stopPropagation();
        if (favorites.includes(id)) favorites = favorites.filter(f => f !== id);
        else favorites.push(id);
        localStorage.setItem('favSongs', JSON.stringify(favorites));
        renderList();
    }

    function renderList() {
        const term = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('song-list');
        const isFavView = colSelect.value === 'favorites';
        
        let filtered = allSongs.filter(s => s.searchKey.includes(term));
        if (isFavView) filtered = filtered.filter(s => favorites.includes(s.id));

        list.innerHTML = filtered.sort((a,b)=>a.title.localeCompare(b.title)).map(s => `
            <li onclick="selectSong('${s.id}')" class="${currentId === s.id ? 'selected' : ''}">
                <span>${s.title}</span>
                <i class="fas fa-star fav-star ${favorites.includes(s.id) ? 'active' : ''}" onclick="toggleFav(event, '${s.id}')"></i>
            </li>
        `).join('');
    }

    // Usprawnienie 2: Wake Lock (Blokada ekranu)
    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }

    function selectSong(id) {
        stopAutoScroll();
        requestWakeLock(); // Aktywuj przy wyborze piosenki
        currentId = id; transpose = 0;
        document.getElementById('controls-bar').style.display = "flex";
        document.body.classList.add('song-active');
        document.getElementById('settings-menu').classList.remove('active');
        updateView();
        renderList();
    }

    // Usprawnienie 5: Podpowiedzi akordów
    function showChordInfo(e, chord) {
        e.stopPropagation();
        const tip = document.getElementById('chord-tooltip');
        tip.innerHTML = `<strong>${chord}</strong><br><div style="font-size:12px; margin-top:5px;">Pozycja palców (przykład):<br></div>`;
        tip.style.display = 'block';
        tip.style.left = (e.clientX + 10) + 'px';
        tip.style.top = (e.clientY + 10) + 'px';
    }
    document.addEventListener('click', () => document.getElementById('chord-tooltip').style.display = 'none');

    // Usprawnienie 8: Metronom (Audio Context)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playClick() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = 1000; gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function toggleMetronome() {
        if (isMetroActive) { clearInterval(metroInterval); isMetroActive = false; }
        else {
            const bpm = document.getElementById('metro-bpm').value;
            metroInterval = setInterval(playClick, (60 / bpm) * 1000);
            isMetroActive = true;
        }
        document.getElementById('btn-metro-toggle').style.color = isMetroActive ? "#28a745" : "inherit";
    }

    // Usprawnienie 3: Import plików
    function importJSON(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                allSongs = imported.map((s, i) => ({ ...s, id: "imp" + Date.now() + i, searchKey: (s.title + " " + s.artist).toLowerCase() }));
                renderList();
                alert("Zaimportowano piosenki!");
            } catch (err) { alert("Błąd pliku JSON"); }
        };
        reader.readAsText(file);
    }

    // --- Funkcje bazowe (Logika piosenki) ---
    const scale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const dScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];

    function transChord(c, s) { return c.replace(/([A-GHa-gh][b#]?)([\w\d\/#\-]*)?/, (m, b, mod) => { let base = b.toUpperCase().replace('H', 'B'); let i = scale.indexOf(base); if (i === -1) return m; i = (i + s % 12 + 12) % 12; let res = dScale[i]; if (b === b.toLowerCase()) res = res.toLowerCase(); return res + (mod || ''); }); }
    
    function updateView() {
        const song = allSongs.find(s => s.id === currentId);
        if (!song) return;
        const lyr = (song.lyrics || "").replace(/\[(.*?)\]/g, (m, c) => {
            const tc = transChord(c, transpose);
            return `<span class="inline-chord" onclick="showChordInfo(event, '${tc}')">${tc}</span>`;
        });
        document.getElementById('song-display').innerHTML = `<h2>${song.title}</h2><p>${song.artist || ''}</p><div style="white-space:pre-wrap; font-size:var(--lyrics-font-size); line-height:1.6;">${lyr}</div>`;
        document.getElementById('transpose-val').textContent = transpose;
    }

    function changeTrans(val) { transpose += val; updateView(); }
    function toggleScroll() { 
        if (isScrolling) { clearInterval(scrollInterval); isScrolling = false; }
        else { isScrolling = true; scrollInterval = setInterval(() => { document.getElementById('main-content').scrollTop += 1; }, 100 - document.getElementById('scroll-speed').value); }
        document.getElementById('btn-scroll-toggle').innerHTML = `<i class="fas fa-${isScrolling ? 'pause' : 'play'}"></i>`;
    }
    function stopAutoScroll() { if (isScrolling) toggleScroll(); }
    function backToList() { document.body.classList.remove('song-active'); stopAutoScroll(); if (wakeLock) wakeLock.release(); }

    // Obsługa menu ustawień
    document.getElementById('btn-settings').onclick = (e) => { e.stopPropagation(); document.getElementById('settings-menu').classList.toggle('active'); };
    document.addEventListener('click', () => document.getElementById('settings-menu').classList.remove('active'));
    document.getElementById('btn-dark-mode').onclick = () => document.body.classList.toggle('dark-mode');
    document.getElementById('search').oninput = renderList;

    loadSongs(COLLECTIONS[0].file);
</script>
</body>
</html>
