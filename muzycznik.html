<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Åšpiewnik Akordowy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
        #app-container { display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 350px; flex-shrink: 0; overflow-y: auto; padding: 10px; border-right: 1px solid #ccc; background-color: #fff; }
        #main-content { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: #fff; }

        .header { padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .filter-controls { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .filter-controls input, .filter-controls select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }

        /* Przycisk Pobierz Wszystko */
        #download-all-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #download-all-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        #song-list { list-style: none; padding: 0; margin: 0; }
        #song-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; transition: background-color 0.2s; }
        #song-list li:hover { background-color: #f0f0f0; }
        #song-list li.selected { background-color: #e0e0e0; font-weight: bold; }
        
        .placeholder { padding: 10px; color: #888; text-align: center; }
        #song-details { padding-top: 20px; background-color: #fff; }
        #song-details h2 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .song-artist { color: #555; font-weight: normal; font-size: 0.9em; }
        
        .chords-container { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background-color: #fffaf0; border-radius: 5px; }
        #active-chords-content { font-family: 'Courier New', monospace; font-size: 16px; white-space: pre-wrap; margin: 0; }
        .inline-chord { font-weight: bold; color: #a0522d; margin-right: 4px; display: inline-block; }
        .lyrics-content { white-space: pre-wrap; font-size: 16px; line-height: 1.6; }

        #controls-bar { display: flex; justify-content: flex-end; align-items: center; gap: 10px; padding: 10px; background-color: #f9f9f9; border-bottom: 1px solid #ddd; }
        #controls-bar button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background-color: #fff; }
        
        #transpose-controls { display: flex; align-items: center; gap: 5px; }
        #current-transpose-value { font-weight: bold; padding: 0 5px; }

        .chords-hidden .chords-container, .chords-hidden .inline-chord { display: none !important; }

        /* Ukryty kontener do renderowania masowego */
        #hidden-render-engine { position: absolute; left: -9999px; top: 0; width: 800px; background: white; }

        @media (max-width: 768px) {
            #main-content { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; transform: translateX(100%); transition: 0.3s; padding-top: 100px; }
            #app-container.mobile-details-active #main-content { transform: translateX(0); }
            #controls-bar { position: fixed; top: 0; left: 0; right: 0; flex-wrap: wrap; }
            #back-to-list-button { display: block !important; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="sidebar">
            <div class="header">
                <h3>ðŸŽ¸ Åšpiewnik</h3>
                <select id="collection-select" style="width: 100%; padding: 8px;"></select>
                <button id="download-all-btn">Pobierz Wszystkie (JPG)</button>
            </div>
            <div class="filter-controls">
                <input type="text" id="search-input" placeholder="Szukaj...">
                <select id="vocal-type-select"><option value="">-- Typ Wokalu --</option></select>
                <select id="genre-select"><option value="">-- Gatunek --</option></select>
            </div>
            <ul id="song-list"></ul>
        </div>

        <div id="main-content">
            <div id="controls-bar" style="display: none;">
                <button id="back-to-list-button" style="display: none;"><i class="fas fa-arrow-left"></i></button>
                <div id="transpose-controls">
                    <button id="transpose-down-button">-</button>
                    <span id="current-transpose-value">0</span>
                    <button id="transpose-up-button">+</button>
                </div>
                <button id="toggle-chords-button">Ukryj Akordy</button>
                <button id="download-jpg-button" style="background:#28a745; color:white;">JPG</button>
            </div>
            <div id="song-details"><div class="placeholder">Wybierz piosenkÄ™.</div></div>
        </div>
    </div>

    <div id="hidden-render-engine"></div>

    <script>
        let allSongs = [];
        let currentFilters = { searchTerm: '', vocalType: '', genre: '' };
        let currentTranspose = 0;
        let currentSongId = null;

        const chromaticScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const displayScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];

        const elements = {
            songList: document.getElementById('song-list'),
            songDetails: document.getElementById('song-details'),
            controlsBar: document.getElementById('controls-bar'),
            hiddenEngine: document.getElementById('hidden-render-engine'),
            downloadAllBtn: document.getElementById('download-all-btn')
        };

        // --- TRANSPOZYCJA ---
        function transposeChord(chord, semitones) {
            const match = chord.match(/([A-GHa-gh][b#]?)([\w\d\/#\-]*)?/);
            if (!match) return chord;
            let note = match[1].toUpperCase();
            if (note === 'H') note = 'B';
            else if (note === 'B') note = 'A#';
            let idx = chromaticScale.indexOf(note);
            if (idx === -1) return chord;
            let newIdx = (idx + semitones % 12 + 12) % 12;
            let res = displayScale[newIdx];
            if (match[1] === match[1].toLowerCase()) res = res.toLowerCase();
            return res + (match[2] || '');
        }

        function processContent(song, semitones) {
            let chords = song.chords ? song.chords.replace(/([A-GHa-gh][b#]?[\w\d\/#\-]*)/g, m => transposeChord(m, semitones)) : '';
            let lyrics = song.lyrics ? song.lyrics.replace(/\[([A-GHa-gh][b#]?[\w\d\/#\-]*)\]/g, (m, c) => `<span class="inline-chord">${transposeChord(c, semitones)}</span>`) : '';
            return { chords, lyrics };
        }

        // --- GENEROWANIE HTML DLA JPG ---
        function createSongHTML(song, semitones = 0) {
            const { chords, lyrics } = processContent(song, semitones);
            return `
                <div style="padding: 40px; background: white; color: #333;">
                    <h2 style="color: #0056b3; border-bottom: 2px solid #eee; margin-bottom:20px;">${song.title} <small>(${song.artist})</small></h2>
                    ${chords ? `<div class="chords-container" style="background:#fffaf0; padding:15px; border:1px solid #ddd; margin-bottom:20px;"><pre style="font-family:monospace; font-size:16px; margin:0;">${chords}</pre></div>` : ''}
                    <div style="font-size:16px; line-height:1.6; white-space:pre-wrap;">${lyrics}</div>
                </div>
            `;
        }

        // --- POBIERANIE WSZYSTKIEGO ---
        async function downloadAllAsJpg() {
            const songsToDownload = allSongs; // Pobiera wszystko z aktualnie wczytanej kolekcji
            if (!confirm(`Czy chcesz pobraÄ‡ ${songsToDownload.length} piosenek jako JPG? PrzeglÄ…darka moÅ¼e zapytaÄ‡ o zgodÄ™ na pobieranie wielu plikÃ³w.`)) return;

            elements.downloadAllBtn.disabled = true;
            elements.downloadAllBtn.innerText = "Trwa generowanie...";

            for (let i = 0; i < songsToDownload.length; i++) {
                const song = songsToDownload[i];
                elements.downloadAllBtn.innerText = `Pobieranie ${i + 1}/${songsToDownload.length}...`;

                // Renderuj do ukrytego silnika
                elements.hiddenEngine.innerHTML = createSongHTML(song, 0);

                const canvas = await html2canvas(elements.hiddenEngine, { scale: 2 });
                const link = document.createElement('a');
                link.download = `Song_${i+1}_${song.title.replace(/\s+/g, '_')}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.8);
                link.click();

                // KrÃ³tka pauza, aby nie zawiesiÄ‡ przeglÄ…darki i pozwoliÄ‡ na pobranie
                await new Promise(r => setTimeout(r, 600));
            }

            elements.downloadAllBtn.disabled = false;
            elements.downloadAllBtn.innerText = "Pobierz Wszystkie (JPG)";
            alert("ZakoÅ„czono pobieranie.");
        }

        // --- RESZTA LOGIKI ---
        async function loadSongs(file) {
            const res = await fetch(file);
            allSongs = await res.json();
            allSongs = allSongs.map((s, i) => ({ ...s, id: i, titleLower: s.title.toLowerCase() }));
            renderList();
        }

        function renderList() {
            elements.songList.innerHTML = allSongs.map(s => `<li data-id="${s.id}">${s.title}</li>`).join('');
        }

        function showDetails(id) {
            currentSongId = id;
            const song = allSongs.find(s => s.id === id);
            elements.songDetails.innerHTML = createSongHTML(song, currentTranspose);
            elements.controlsBar.style.display = 'flex';
            if(window.innerWidth <= 768) document.getElementById('app-container').classList.add('mobile-details-active');
        }

        // --- EVENTY ---
        elements.downloadAllBtn.addEventListener('click', downloadAllAsJpg);
        elements.songList.addEventListener('click', e => {
            const li = e.target.closest('li');
            if (li) showDetails(parseInt(li.dataset.id));
        });

        document.getElementById('download-jpg-button').addEventListener('click', async () => {
            const canvas = await html2canvas(elements.songDetails, { scale: 2 });
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/jpeg');
            link.download = 'piosenka.jpg';
            link.click();
        });

        document.getElementById('back-to-list-button').onclick = () => document.getElementById('app-container').classList.remove('mobile-details-active');

        // Inicjalizacja (pamiÄ™taj o swoich plikach JSON)
        loadSongs('piosenki.json'); 
    </script>
</body>
</html>
