<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Śpiewnik - Twoje Pliki JSON</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f4f4;
            --bg-sidebar: #ffffff;
            --bg-main: #ffffff;
            --text-main: #333;
            --text-chords: #a0522d;
            --border-color: #ccc;
            --accent-success: #28a745;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-main: #181818;
            --text-main: #e0e0e0;
            --text-chords: #ff9f43;
            --border-color: #444;
        }

        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; }
        #app-container { display: flex; height: 100vh; }
        
        #sidebar { 
            width: 320px; border-right: 1px solid var(--border-color); 
            background: var(--bg-sidebar); padding: 15px; display: flex; flex-direction: column; 
        }
        #main-content { flex-grow: 1; overflow-y: auto; background: var(--bg-main); }

        .header-select { margin-bottom: 15px; }
        .header-select select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-sidebar); color: var(--text-main); }

        #song-list { list-style: none; padding: 0; overflow-y: auto; flex-grow: 1; margin-top: 10px; }
        #song-list li { padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 14px; }
        #song-list li:hover { background: rgba(0,0,0,0.05); }
        #song-list li.selected { background: var(--border-color); font-weight: bold; }

        #controls-bar { 
            display: flex; gap: 10px; padding: 10px; background: #eee; 
            border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 10; 
        }
        body.dark-mode #controls-bar { background: #252525; color: #eee; }

        #song-capture-area { padding: 40px; background: white; color: black; min-height: 100%; }
        .export-mode { width: 800px !important; color: black !important; background: white !important; }

        .chords-container { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 5px; }
        #active-chords-content { font-family: 'Courier New', monospace; font-size: 16px; white-space: pre-wrap; margin: 0; color: black; }
        .lyrics-content { white-space: pre-wrap; font-size: 19px; line-height: 1.6; margin-top: 20px; color: black; }
        .inline-chord { font-weight: bold; color: var(--text-chords); }

        button { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-sidebar); color: var(--text-main); }
        .btn-green { background: var(--accent-success); color: white; border: none; }
        
        #progress-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white; z-index: 100;
            flex-direction: column; align-items: center; justify-content: center;
        }

        .placeholder { padding: 40px; text-align: center; color: #888; }
    </style>
</head>
<body>

<div id="progress-overlay">
    <h2 id="progress-text">Generowanie plików JPG...</h2>
    <p id="progress-count">0 / 0</p>
    <small>Nie zamykaj okna przeglądarki</small>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="header-select">
            <label style="font-size: 12px; font-weight: bold;">WYBIERZ ZBIÓR:</label>
            <select id="collection-select"></select>
        </div>
        <input type="text" id="search" placeholder="Szukaj w tym zbiorze..." style="width:100%; padding:8px; box-sizing: border-box;">
        <ul id="song-list"></ul>
        
        <div style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px;">
            <button id="btn-export-all" class="btn-green" style="width:100%;">
                <i class="fas fa-file-export"></i> Eksportuj ten zbiór do JPG
            </button>
        </div>
    </div>

    <div id="main-content">
        <div id="controls-bar" style="display:none;">
            <button id="btn-transpose-down"><i class="fas fa-minus"></i></button>
            <span id="transpose-val" style="min-width: 20px; text-align: center; font-weight: bold;">0</span>
            <button id="btn-transpose-up"><i class="fas fa-plus"></i></button>
            <button id="btn-toggle-chords">Ukryj akordy</button>
            <button id="btn-jpg" class="btn-green"><i class="fas fa-image"></i> Pobierz JPG</button>
            <button id="btn-dark-mode"><i class="fas fa-moon"></i></button>
        </div>

        <div id="song-capture-area">
            <div id="song-display">
                <div class="placeholder">Wybierz piosenkę z listy po lewej stronie.</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURACJA TWOICH PLIKÓW ---
    const COLLECTIONS = [
        { name: "Główny Zbiór", file: 'piosenki.json' },
        { name: "Kolędy", file: 'koledy.json' },
        { name: "Inne", file: 'lukasz.json' }
    ];

    let allSongs = [], currentId = null, transpose = 0, showChords = true;
    const scale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const dScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];

    // Inicjalizacja selecta zbiorów
    const colSelect = document.getElementById('collection-select');
    COLLECTIONS.forEach(c => colSelect.add(new Option(c.name, c.file)));

    // --- LOGIKA ŁADOWANIA ---
    async function loadSongs(file) {
        const list = document.getElementById('song-list');
        list.innerHTML = '<li>Ładowanie piosenek...</li>';
        
        try {
            const response = await fetch(file);
            if (!response.ok) throw new Error("Nie znaleziono pliku");
            const data = await response.json();
            
            // Mapujemy dane, dodając unikalne ID dla sesji
            allSongs = data.map((s, index) => ({
                ...s,
                id: index,
                searchKey: (s.title + " " + s.artist).toLowerCase()
            }));

            // Sortowanie alfabetyczne
            allSongs.sort((a, b) => a.title.localeCompare(b.title));
            
            renderList();
            document.getElementById('song-display').innerHTML = '<div class="placeholder">Wybierz piosenkę ze zbioru.</div>';
            document.getElementById('controls-bar').style.display = 'none';
        } catch (error) {
            list.innerHTML = `<li style="color:red">Błąd: ${error.message}. Sprawdź czy plik ${file} istnieje.</li>`;
        }
    }

    // --- RENDEROWANIE ---
    function renderList() {
        const term = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('song-list');
        const filtered = allSongs.filter(s => s.searchKey.includes(term));
        
        list.innerHTML = filtered.map(s => `
            <li onclick="selectSong(${s.id})" class="${currentId === s.id ? 'selected' : ''}">
                ${s.title} <span style="font-size:11px; opacity:0.6">(${s.artist})</span>
            </li>
        `).join('');
    }

    function transChord(c, s) {
        return c.replace(/([A-GHa-gh][b#]?)([\w\d\/#\-]*)?/, (m, b, mod) => {
            let base = b.toUpperCase().replace('H', 'B');
            let i = scale.indexOf(base);
            if (i === -1) return m;
            i = (i + s % 12 + 12) % 12;
            let res = dScale[i];
            if (b === b.toLowerCase()) res = res.toLowerCase();
            return res + (mod || '');
        });
    }

    function generateSongHTML(song, trans, visible) {
        let html = `<h2>${song.title} <small style="color:#666">(${song.artist})</small></h2>`;
        
        if (visible && song.chords) {
            const tc = song.chords.replace(/([A-GHa-gh][b#]?[\w\d\/#\-]*)/g, m => transChord(m, trans));
            html += `<div class="chords-container"><pre id="active-chords-content">${tc}</pre></div>`;
        }

        let lyr = song.lyrics || "";
        if (visible) {
            lyr = lyr.replace(/\[(.*?)\]/g, (m, c) => `<span class="inline-chord">${transChord(c, trans)}</span>`);
        } else {
            lyr = lyr.replace(/\[.*?\]/g, '').replace(/^\s*[\r\n]/gm, '');
        }
        
        html += `<div class="lyrics-content">${lyr}</div>`;
        return html;
    }

    window.selectSong = (id) => {
        currentId = id; transpose = 0;
        document.getElementById('transpose-val').textContent = "0";
        document.getElementById('controls-bar').style.display = "flex";
        
        const song = allSongs.find(s => s.id === id);
        document.getElementById('song-display').innerHTML = generateSongHTML(song, transpose, showChords);
        renderList();
    };

    // --- EKSPORT ---
    async function saveAsJpg(element, name) {
        element.classList.add('export-mode');
        const canvas = await html2canvas(element, { backgroundColor: "#ffffff", scale: 2 });
        const link = document.createElement('a');
        link.download = name.replace(/[<>:"/\\|?*]/g, '') + ".jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        link.click();
        element.classList.remove('export-mode');
    }

    document.getElementById('btn-export-all').onclick = async function() {
        if (!allSongs.length) return;
        if (!confirm(`Rozpocząć seryjne pobieranie ${allSongs.length} plików JPG?`)) return;

        const overlay = document.getElementById('progress-overlay');
        const countText = document.getElementById('progress-count');
        const area = document.getElementById('song-capture-area');
        const display = document.getElementById('song-display');

        overlay.style.display = 'flex';

        for (let i = 0; i < allSongs.length; i++) {
            const s = allSongs[i];
            countText.textContent = `${i + 1} / ${allSongs.length}: ${s.title}`;
            display.innerHTML = generateSongHTML(s, 0, showChords);
            
            await new Promise(r => setTimeout(r, 400)); // Czas na render
            await saveAsJpg(area, s.title);
        }

        overlay.style.display = 'none';
        alert("Gotowe!");
        if (currentId !== null) selectSong(currentId);
    };

    // Obsługa eventów
    document.getElementById('btn-transpose-up').onclick = () => { transpose++; document.getElementById('transpose-val').textContent = transpose; selectSong(currentId); };
    document.getElementById('btn-transpose-down').onclick = () => { transpose--; document.getElementById('transpose-val').textContent = transpose; selectSong(currentId); };
    document.getElementById('btn-toggle-chords').onclick = function() { showChords = !showChords; this.textContent = showChords ? "Ukryj akordy" : "Pokaż akordy"; selectSong(currentId); };
    document.getElementById('btn-jpg').onclick = () => saveAsJpg(document.getElementById('song-capture-area'), allSongs.find(s=>s.id===currentId).title);
    document.getElementById('btn-dark-mode').onclick = () => document.body.classList.toggle('dark-mode');
    document.getElementById('search').oninput = renderList;
    colSelect.onchange = (e) => loadSongs(e.target.value);

    // Start
    loadSongs(COLLECTIONS[0].file);
</script>

</body>
</html>
