<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>≈öpiewnik Pro 2025 (MQTT Sync)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f4f4; --bg-sidebar: #ffffff; --bg-main: #ffffff; --bg-song-area: #ffffff;
            --text-main: #333; --text-song: #000000; --text-chords: #a0522d;
            --border-color: #ccc; --accent-success: #28a745; --accent-blue: #007bff; --lyrics-font-size: 18px;
        }
        body.dark-mode {
            --bg-body: #121212; --bg-sidebar: #1e1e1e; --bg-main: #181818; --bg-song-area: #181818;
            --text-main: #e0e0e0; --text-song: #ffffff; --text-chords: #ff9f43; --border-color: #444;
        }
        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; overflow: hidden; text-align: left; }
        #app-container { display: flex; height: 100vh; width: 100vw; position: relative; }
        
        #sidebar { width: 320px; border-right: 1px solid var(--border-color); background: var(--bg-sidebar); padding: 15px; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 20; text-align: left; }
        #main-content { flex-grow: 1; overflow-y: auto; background: var(--bg-main); scroll-behavior: smooth; position: relative; z-index: 10; touch-action: pan-y; text-align: left; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; box-sizing: border-box; }
            #main-content { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            body.song-active #main-content { transform: translateX(0); }
            body.song-active #sidebar { transform: translateX(-100%); }
            .mobile-only { display: inline-block !important; }
        }
        .mobile-only { display: none; }

        .sidebar-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        #controls-bar { display: flex; gap: 8px; padding: 10px; background: #eee; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 30; align-items: center; overflow-x: auto; }
        body.dark-mode #controls-bar { background: #252525; border-color: #444; }

        .control-group { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 6px; white-space: nowrap; }

        #settings-menu { display: none; position: absolute; top: 55px; right: 10px; background: var(--bg-sidebar); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); flex-direction: column; gap: 12px; min-width: 260px; z-index: 100; overflow-y: auto; max-height: 80vh; text-align: left; }
        #settings-menu.active { display: flex; }

        #song-capture-area { padding: 25px; background: var(--bg-song-area); color: var(--text-song); min-height: 100%; text-align: left; }
        .song-header { text-align: center; margin-bottom: 20px; }
        
        .chords-container { background: rgba(128,128,128,0.1); border: 1px solid var(--border-color); padding: 15px; margin: 15px 0; border-radius: 5px; text-align: left; }
        #active-chords-content { font-family: 'Courier New', monospace; font-size: calc(var(--lyrics-font-size) * 0.9); white-space: pre-wrap; margin: 0; color: var(--text-song); text-align: left; }
        .lyrics-content { white-space: pre-wrap; font-size: var(--lyrics-font-size); line-height: 1.6; margin-top: 20px; color: var(--text-song); text-align: left; }
        .inline-chord { font-weight: bold; color: var(--text-chords); cursor: pointer; }

        button { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-sidebar); color: var(--text-main); font-size: 14px; text-align: center; }
        .btn-icon { border: none; background: transparent; font-size: 18px; padding: 5px 8px; }

        #song-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; text-align: left; }
        #song-list li { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        #song-list li.selected { background: var(--accent-blue); color: white; }
        .fav-star { color: #ccc; transition: 0.2s; padding: 5px; }
        .fav-star.active { color: #ffc107; }

        #editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-sidebar); padding: 20px; border-radius: 8px; width: 95%; max-width: 500px; text-align: left; }
        #chord-tooltip { position: fixed; display: none; background: white; border: 2px solid #333; border-radius: 8px; padding: 10px; z-index: 2000; color: black; box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-size: 14px; }
        
        .filter-tags { display: flex; gap: 5px; margin-bottom: 10px; }
        .filter-tags button { flex: 1; padding: 5px; font-size: 12px; }
        
        /* Status po≈ÇƒÖczenia */
        .connection-dot { display:inline-block; width:10px; height:10px; border-radius:50%; background:red; margin-right:5px; }
        .connected { background: #28a745; }
    </style>
</head>
<body>

<div id="chord-tooltip"></div>
<div id="progress-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:white; z-index:2100; flex-direction:column; align-items:center; justify-content:center;">
    <h2>Eksport...</h2><p id="progress-count">0/0</p>
</div>

<div id="editor-modal">
    <div class="modal-content">
        <h3>‚ûï Edytor</h3>
        <input type="text" id="edit-title" placeholder="Tytu≈Ç" style="width:100%; margin-bottom:10px; padding:8px;">
        <input type="text" id="edit-artist" placeholder="Wykonawca" style="width:100%; margin-bottom:10px; padding:8px;">
        <input type="text" id="edit-genre" placeholder="Gatunek (np. Pop, Rock)" style="width:100%; margin-bottom:10px; padding:8px;">
        <select id="edit-vocal" style="width:100%; margin-bottom:10px; padding:8px;">
            <option value="">Wybierz typ wokalu...</option>
            <option value="male">Mƒôski (male)</option>
            <option value="female">≈ªe≈Ñski (female)</option>
            <option value="duo">Duet / Inne</option>
        </select>
        <textarea id="edit-lyrics" placeholder="Tekst [C]z akordami... {Komentarze}" style="width:100%; margin-bottom:10px; padding:8px; height:150px; font-family:monospace;"></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="closeEditor()" style="flex:1">Anuluj</button>
            <button onclick="saveSongData()" style="flex:1; background:var(--accent-success); color:white;">Zapisz</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="sidebar-header">
            <select id="collection-select" style="flex-grow:1; padding:10px; font-weight: bold;">
                <option value="piosenki.json">üìÅ Piosenki (G≈Ç√≥wna)</option>
                <option value="koledy.json">üéÑ Kolƒôdy</option>
                <option value="lukasz.json">üë§ Inne</option>
                <option value="favorites">‚≠ê Ulubione</option>
            </select>
            <button class="btn-icon" onclick="openSettings(event)"><i class="fas fa-cog"></i></button>
        </div>
        
        <div class="filter-tags">
            <button onclick="setSearch('male')">‚ôÇ Mƒôski</button>
            <button onclick="setSearch('female')">‚ôÄ ≈ªe≈Ñski</button>
            <button onclick="setSearch('')" style="background:#eee; color:black;">Wszystkie</button>
        </div>

        <input type="text" id="search" placeholder="Szukaj (Tytu≈Ç, Artysta)..." style="width: 150px; padding:12px; margin-bottom:10px; border-radius: 20px; border: 1px solid var(--border-color);">
        <ul id="song-list"></ul>
    </div>

    <div id="main-content">
        <div id="controls-bar" style="display:none;">
            <button onclick="backToList()" class="mobile-only btn-icon"><i class="fas fa-arrow-left"></i></button>
            
            <div class="control-group">
                <button onclick="changeTrans(-1)" class="btn-icon"><i class="fas fa-minus"></i></button>
                <span id="transpose-val" onclick="resetTrans()" style="font-weight:bold; min-width:30px; text-align:center; cursor:pointer; padding: 0 5px;" title="Reset">0</span>
                <button onclick="changeTrans(1)" class="btn-icon"><i class="fas fa-plus"></i></button>
            </div>

            <div class="control-group">
                <button id="btn-scroll-toggle" onclick="toggleScroll()" class="btn-icon"><i class="fas fa-play"></i></button>
                <input type="range" id="scroll-speed" min="1" max="50" value="10" style="width:50px;">
            </div>
            <button onclick="toggleMetronome()" id="btn-metro-toggle" class="btn-icon"><i class="fas fa-drum"></i></button>
            <div style="flex-grow: 1;"></div>
            <button class="btn-icon" onclick="openSettings(event)"><i class="fas fa-cog"></i></button>
        </div>

        <div id="settings-menu">
            <div style="font-size:12px; font-weight:bold;">Czcionka: <span id="font-size-val">18px</span></div>
            <input type="range" id="font-size-slider" min="12" max="60" value="18" oninput="setFontSize(this.value)">
            <button onclick="toggleChordsDisplay()" id="btn-toggle-chords">Ukryj akordy</button>
            <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Tryb nocny</button>
            
            <div style="border-top: 1px solid var(--border-color); margin-top: 10px; padding-top: 10px; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 5px;">
                <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display:flex; align-items:center;">
                    <span id="conn-status-dot" class="connection-dot"></span> SYNCHRONIZACJA
                </div>
                <div style="font-size: 11px; margin-bottom: 5px; color:#666;">Wpisz to samo has≈Ço na wszystkich tabletach:</div>
                <input type="text" id="mqtt-room-code" placeholder="Np. Zespol1" style="width:100%; padding:5px; margin-bottom:5px; box-sizing:border-box;">
                <div style="display:flex; gap:5px;">
                    <button onclick="connectMQTT(true)" style="flex:1; background:#007bff; color:white;">Lider</button>
                    <button onclick="connectMQTT(false)" style="flex:1;">S≈Çuchacz</button>
                </div>
                <div id="mqtt-status-text" style="font-size:10px; color:green; margin-top:5px; min-height:15px;"></div>
            </div>

            <hr style="opacity:0.2; margin-top: 10px;">
            <button onclick="startEditCurrent()">Edytuj piosenkƒô</button>
            <button onclick="startNewSong()">Dodaj nowƒÖ</button>
            <button onclick="document.getElementById('import-file').click()">Importuj JSON</button>
            <input type="file" id="import-file" style="display:none" onchange="importJSON(this)">
            <button onclick="exportJSON()">Pobierz JSON</button>
            <button onclick="exportAllJPG()" style="background:var(--accent-success); color:white;">Eksport JPG</button>
            <button onclick="resetFromServer()" style="background:#dc3545; color:white;">Resetuj z serwera</button>
        </div>

        <div id="song-capture-area">
            <div id="song-display" style="padding:40px; text-align:center; color:#888;">Wybierz piosenkƒô...</div>
        </div>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    // Ustawienia Skali (B/H Fix)
    const scale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const dScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];
    
    let allSongs = [];
    let currentLibrary = "piosenki.json";
    let favorites = JSON.parse(localStorage.getItem('favSongs') || '[]');
    let currentId = null, lastId = null, transpose = 0, showChords = true;
    let scrollInterval = null, isScrolling = false, metroInterval = null, isMetroActive = false;
    let currentFontSize = 18;

    // --- ZMIENNE MQTT ---
    let mqttClient = null;
    let isMaster = false;
    let mqttTopic = "";

    // Gesty dotykowe (szczypanie i przesuwanie)
    let touchStartX = 0;
    let touchStartY = 0;
    let initialPinchDist = -1;

    document.addEventListener('touchstart', e => {
        if (e.touches.length === 1) {
            touchStartX = e.touches[0].screenX;
            touchStartY = e.touches[0].screenY;
        } else if (e.touches.length === 2) {
            initialPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        }
    }, {passive: false});

    document.addEventListener('touchmove', e => {
        if (e.touches.length === 2 && initialPinchDist > 0) {
            e.preventDefault(); 
            let dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            let diff = dist - initialPinchDist;
            if (Math.abs(diff) > 15) { 
                let step = diff > 0 ? 1 : -1;
                let newSize = currentFontSize + step;
                if (newSize >= 12 && newSize <= 60) setFontSize(newSize);
                initialPinchDist = dist; 
            }
        }
    }, {passive: false});

    document.addEventListener('touchend', e => {
        if (e.changedTouches.length === 1) {
            let touchEndX = e.changedTouches[0].screenX;
            let diffX = touchEndX - touchStartX;
            if (Math.abs(diffX) > 80) {
                if (diffX > 80 && document.body.classList.contains('song-active')) backToList();
                else if (diffX < -80 && !document.body.classList.contains('song-active') && lastId) selectSong(lastId);
            }
        }
        initialPinchDist = -1;
    }, false);

    document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('collection-select');
        switchLibrary(selector.value);
        selector.onchange = (e) => switchLibrary(e.target.value);
        document.getElementById('search').oninput = renderList;
        
        // Przywr√≥ƒá kod pokoju z pamiƒôci
        if(localStorage.getItem('mqttRoom')) document.getElementById('mqtt-room-code').value = localStorage.getItem('mqttRoom');
    });

    async function switchLibrary(lib) {
        currentLibrary = lib;
        if (lib === "favorites") {
            const allSaved = [];
            ["piosenki.json", "koledy.json", "lukasz.json"].forEach(key => {
                const data = JSON.parse(localStorage.getItem('db_' + key) || '[]');
                allSaved.push(...data);
            });
            allSongs = allSaved.filter(s => favorites.includes(s.id));
            renderList();
        } else {
            const saved = localStorage.getItem('db_' + lib);
            if (saved) { allSongs = JSON.parse(saved); renderList(); } 
            else { await loadFromServer(lib); }
        }
    }

    async function loadFromServer(fileName) {
        try {
            const res = await fetch(fileName);
            const data = await res.json();
            allSongs = data.map((s, i) => ({ ...s, id: fileName + "_" + i }));
            saveToLocal(); renderList();
        } catch (e) { console.error("B≈ÇƒÖd ≈Çadowania:", e); }
    }

    function saveToLocal() { if (currentLibrary !== "favorites") localStorage.setItem('db_' + currentLibrary, JSON.stringify(allSongs)); }

    function renderList() {
        const term = document.getElementById('search').value.toLowerCase().trim();
        const list = document.getElementById('song-list');
        
        let filtered = allSongs.filter(s => {
            const title = (s.title || "").toLowerCase();
            const artist = (s.artist || "").toLowerCase();
            const genre = (s.genre || "").toLowerCase();
            const vocal = (s.vocal_type || "").toLowerCase();

            if (term === "male") return title.includes(term) || artist.includes(term) || genre.includes(term) || vocal === "male";
            return title.includes(term) || artist.includes(term) || genre.includes(term) || vocal.includes(term);
        });

        list.innerHTML = filtered.sort((a,b)=>a.title.localeCompare(b.title)).map(s => `
            <li onclick="selectSong('${s.id}')" class="${currentId === s.id ? 'selected' : ''}">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold;">${s.title}</span>
                    <span style="font-size:0.8em; opacity:0.7;">
                        ${s.artist || ''} 
                        ${s.genre ? '‚Ä¢ ' + s.genre : ''} 
                        ${s.vocal_type === 'female' ? '‚ôÄ' : s.vocal_type === 'male' ? '‚ôÇ' : ''}
                    </span>
                </div>
                <i class="fas fa-star fav-star ${favorites.includes(s.id) ? 'active' : ''}" onclick="toggleFav(event, '${s.id}')"></i>
            </li>
        `).join('');
    }

    function setSearch(val) {
        document.getElementById('search').value = val;
        renderList();
    }

    function selectSong(id, fromMqtt = false) {
        stopAutoScroll(); 
        if (currentId && currentId !== id) lastId = currentId; 
        currentId = id; 
        // Je≈õli wybiera u≈ºytkownik, resetujemy transpozycjƒô. Je≈õli MQTT, czekamy na update transpozycji (lub wysy≈Çamy 0)
        if(!fromMqtt) transpose = 0; 
        
        document.getElementById('controls-bar').style.display = "flex";
        document.body.classList.add('song-active');
        
        if (!history.state || history.state.view !== 'song') history.pushState({view: 'song'}, ''); 
        
        updateView(); 
        renderList();
        document.getElementById('main-content').scrollTop = 0;
        
        // MQTT: Wy≈õlij informacjƒô (je≈õli jeste≈õ liderem)
        if (!fromMqtt) broadcastState();
    }

    function backToList(doPopState = true) {
        if (currentId) lastId = currentId;
        document.body.classList.remove('song-active'); 
        stopAutoScroll();
        if (doPopState && history.state && history.state.view === 'song') history.back();
    }

    // --- POPRAWIONA FUNKCJA TRANSPOZYCJI (B/H Fix) ---
    function transChord(c, s) { 
        return c.replace(/([A-GHa-gh][b#]?)([\w\d\/#\-]*)?/, (m, b, mod) => { 
            let base = b.toUpperCase(); 
            let i = dScale.indexOf(base); 
            if (i === -1) return m; 
            i = (i + s % 12 + 12) % 12; 
            let res = dScale[i]; 
            if (b === b.toLowerCase()) res = res.toLowerCase(); 
            return res + (mod || ''); 
        }); 
    }

    function updateView() {
        const song = allSongs.find(s => s.id === currentId);
        if (!song) return;
        let html = `<div class="song-header"><h2>${song.title}</h2><h4>${song.artist || ''}</h4></div>`;
        
        if (song.chords && showChords) {
            const tc = song.chords.replace(/\{.*?\}|([A-GHa-gh][b#]?[\w\d\/#\-]*)/g, (m, chord) => {
                if (chord) return transChord(chord, transpose); 
                return m; 
            });
            html += `<div class="chords-container"><pre id="active-chords-content">${tc}</pre></div>`;
        }
        
        const lyr = (song.lyrics || "")
            .replace(/\{(.*?)\}/g, '<span style="color: gray; font-style: italic;">$1</span>') 
            .replace(/\[(.*?)\]/g, showChords ? (m, c) => {
                const tc = transChord(c, transpose);
                return `<span class="inline-chord" onclick="showChordInfo(event, '${tc}')">${tc}</span>`;
            } : '');

        document.getElementById('song-display').innerHTML = html + `<div class="lyrics-content">${lyr}</div>`;
        document.getElementById('transpose-val').textContent = (transpose > 0 ? '+' : '') + transpose;
    }

    function changeTrans(v) { 
        transpose += v; 
        updateView(); 
        broadcastState(); 
    }
    
    function resetTrans() { 
        transpose = 0; 
        updateView(); 
        broadcastState(); 
    }
    
    function setFontSize(v) { 
        currentFontSize = parseInt(v);
        document.documentElement.style.setProperty('--lyrics-font-size', currentFontSize + 'px'); 
        document.getElementById('font-size-val').textContent = currentFontSize + 'px'; 
        const slider = document.getElementById('font-size-slider');
        if(slider) slider.value = currentFontSize;
    }

    function toggleFav(e, id) { e.stopPropagation(); favorites.includes(id) ? favorites = favorites.filter(f=>f!==id) : favorites.push(id); localStorage.setItem('favSongs', JSON.stringify(favorites)); renderList(); }
    function openSettings(e) { e.stopPropagation(); document.getElementById('settings-menu').classList.toggle('active'); }
    function toggleChordsDisplay() { showChords = !showChords; updateView(); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    
    function toggleScroll() { 
        isScrolling = !isScrolling; 
        const btn = document.getElementById('btn-scroll-toggle');
        if (isScrolling) {
            btn.innerHTML = '<i class="fas fa-pause"></i>';
            scrollInterval = setInterval(() => document.getElementById('main-content').scrollTop += 1, 105 - document.getElementById('scroll-speed').value); 
        } else {
            btn.innerHTML = '<i class="fas fa-play"></i>';
            clearInterval(scrollInterval); 
        }
    }
    
    function stopAutoScroll() { 
        if(isScrolling) { clearInterval(scrollInterval); isScrolling = false; document.getElementById('btn-scroll-toggle').innerHTML = '<i class="fas fa-play"></i>'; } 
    }

    function toggleMetronome() {
        if (isMetroActive) { clearInterval(metroInterval); isMetroActive = false; }
        else {
            isMetroActive = true;
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            metroInterval = setInterval(() => {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.value = 1000; gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            }, 500);
        }
        document.getElementById('btn-metro-toggle').style.color = isMetroActive ? "var(--accent-success)" : "inherit";
    }

    async function exportAllJPG() {
        const ov = document.getElementById('progress-overlay'); ov.style.display = 'flex';
        const currentBackup = currentId;
        for (let i = 0; i < allSongs.length; i++) {
            currentId = allSongs[i].id; updateView(); await new Promise(r => setTimeout(r, 600));
            const canvas = await html2canvas(document.getElementById('song-capture-area'), {scale: 2});
            const link = document.createElement('a'); link.download = allSongs[i].title + ".jpg";
            link.href = canvas.toDataURL("image/jpeg"); link.click();
            document.getElementById('progress-count').textContent = (i+1) + "/" + allSongs.length;
        }
        currentId = currentBackup; updateView();
        ov.style.display = 'none';
    }

    function exportJSON() {
        const b = new Blob([JSON.stringify(allSongs, null, 2)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = currentLibrary; a.click();
    }

    function importJSON(input) {
        const r = new FileReader(); r.onload = (e) => { allSongs = JSON.parse(e.target.result); saveToLocal(); renderList(); };
        r.readAsText(input.files[0]);
    }

    function resetFromServer() { if (confirm("Resetuj bibliotekƒô?")) { localStorage.removeItem('db_' + currentLibrary); loadFromServer(currentLibrary); } }
    
    let editingId = null;
    function startNewSong() { 
        editingId = null; document.getElementById('edit-title').value=""; document.getElementById('edit-artist').value=""; 
        document.getElementById('edit-lyrics').value=""; document.getElementById('edit-genre').value=""; document.getElementById('edit-vocal').value="";
        document.getElementById('editor-modal').style.display='flex'; 
    }
    function startEditCurrent() { 
        const s = allSongs.find(x=>x.id===currentId); if(!s) return;
        editingId = currentId; 
        document.getElementById('edit-title').value = s.title; document.getElementById('edit-artist').value = s.artist || ""; 
        document.getElementById('edit-lyrics').value = s.lyrics || ""; document.getElementById('edit-genre').value = s.genre || "";
        document.getElementById('edit-vocal').value = s.vocal_type || "";
        document.getElementById('editor-modal').style.display='flex'; 
    }
    function closeEditor() { document.getElementById('editor-modal').style.display='none'; }
    function saveSongData() {
        const title = document.getElementById('edit-title').value;
        const artist = document.getElementById('edit-artist').value;
        const lyrics = document.getElementById('edit-lyrics').value;
        const genre = document.getElementById('edit-genre').value;
        const vocal_type = document.getElementById('edit-vocal').value;
        
        if (editingId) {
            const s = allSongs.find(x=>x.id===editingId); 
            s.title = title; s.artist = artist; s.lyrics = lyrics; s.genre = genre; s.vocal_type = vocal_type;
        } else {
            const n = { title, artist, lyrics, genre, vocal_type, id: "n"+Date.now() }; 
            allSongs.push(n); selectSong(n.id);
        }
        saveToLocal(); renderList(); updateView(); closeEditor();
    }
    function showChordInfo(e, chord) {
        e.stopPropagation();
        const tip = document.getElementById('chord-tooltip');
        tip.innerHTML = `<strong>${chord}</strong><br>Diagram akordu`;
        tip.style.display = 'block'; tip.style.left = Math.min(e.clientX, window.innerWidth - 150) + 'px'; tip.style.top = (e.clientY + 20) + 'px';
    }
    document.addEventListener('click', () => { document.getElementById('settings-menu').classList.remove('active'); document.getElementById('chord-tooltip').style.display = 'none'; });

    // --- LOGIKA MQTT (STABILNA SYNCHRONIZACJA) ---
    function connectMQTT(masterMode) {
        const roomCode = document.getElementById('mqtt-room-code').value.trim();
        if (!roomCode) return alert("Wpisz has≈Ço pokoju (np. Zespol1)!");

        localStorage.setItem('mqttRoom', roomCode);
        isMaster = masterMode;
        // Unikalny topic dla Waszego zespo≈Çu
        mqttTopic = "spiewnik_pro_app_sync/" + roomCode; 

        const options = {
            clean: true,
            connectTimeout: 4000,
            // Darmowy publiczny broker MQTT (WebSockets Secure)
            clientId: 'client_' + Math.random().toString(16).substr(2, 8)
        };

        // ≈ÅƒÖczymy siƒô z darmowym brokerem EMQX
        const brokerUrl = 'wss://broker.emqx.io:8084/mqtt';
        
        document.getElementById('mqtt-status-text').textContent = "≈ÅƒÖczenie z chmurƒÖ...";
        
        if (mqttClient) mqttClient.end();
        mqttClient = mqtt.connect(brokerUrl, options);

        mqttClient.on('connect', function () {
            document.getElementById('conn-status-dot').classList.add('connected');
            document.getElementById('mqtt-status-text').textContent = isMaster ? "Po≈ÇƒÖczono jako Lider" : "Po≈ÇƒÖczono jako S≈Çuchacz";
            console.log("MQTT Connected to " + mqttTopic);
            
            // S≈Çuchacz subskrybuje kana≈Ç
            if (!isMaster) {
                mqttClient.subscribe(mqttTopic, (err) => {
                    if (!err) console.log("Subskrypcja OK");
                });
            } else {
                // Lider wysy≈Ça od razu obecny stan
                broadcastState();
            }
        });

        mqttClient.on('message', function (topic, message) {
            // Tylko s≈Çuchacz reaguje na wiadomo≈õci
            if (!isMaster && topic === mqttTopic) {
                try {
                    const data = JSON.parse(message.toString());
                    console.log("Odebrano:", data);
                    
                    if (data.id && data.id !== currentId) {
                        selectSong(data.id, true); // true = fromMqtt
                    }
                    if (data.t !== undefined && data.t !== transpose) {
                        transpose = data.t;
                        updateView();
                        document.getElementById('transpose-val').textContent = (transpose > 0 ? '+' : '') + transpose;
                    }
                } catch (e) { console.error("B≈ÇƒÖd danych MQTT", e); }
            }
        });

        mqttClient.on('error', (err) => {
            console.error('MQTT Error: ', err);
            document.getElementById('mqtt-status-text').textContent = "B≈ÇƒÖd po≈ÇƒÖczenia";
            document.getElementById('conn-status-dot').classList.remove('connected');
        });
    }

    function broadcastState() {
        if (isMaster && mqttClient && mqttClient.connected) {
            const payload = JSON.stringify({
                id: currentId,
                t: transpose
            });
            mqttClient.publish(mqttTopic, payload, { retain: true }); // retain: true sprawia, ≈ºe nowy s≈Çuchacz dostanie ostatni stan od razu po wej≈õciu
        }
    }
</script>
</body>
</html>
