<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Muzycznik PRO</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f4f4; --bg-sidebar: #ffffff; --bg-main: #ffffff; --bg-song-area: #ffffff;
            --text-main: #333; --text-song: #000000; --text-chords: #a0522d;
            --border-color: #ccc; --accent-success: #28a745; --accent-blue: #007bff; --lyrics-font-size: 18px;
        }
        body.dark-mode {
            --bg-body: #121212; --bg-sidebar: #1e1e1e; --bg-main: #181818; --bg-song-area: #181818;
            --text-main: #e0e0e0; --text-song: #ffffff; --text-chords: #ff9f43; --border-color: #444;
        }
        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; overflow: hidden; text-align: left; }
        #app-container { display: flex; height: 100vh; width: 100vw; position: relative; }
        
        /* SIDEBAR */
        #sidebar { width: 320px; border-right: 1px solid var(--border-color); background: var(--bg-sidebar); padding: 15px; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 20; text-align: left; box-sizing: border-box; }
        #main-content { flex-grow: 1; overflow-y: auto; background: var(--bg-main); scroll-behavior: smooth; position: relative; z-index: 10; touch-action: pan-y; text-align: left; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; }
            #main-content { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            body.song-active #main-content { transform: translateX(0); }
            body.song-active #sidebar { transform: translateX(-100%); }
        }

        /* CONTROLS */
        #controls-bar { display: none; gap: 8px; padding: 10px; background: #eee; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 30; align-items: center; overflow-x: auto; white-space: nowrap; }
        body.dark-mode #controls-bar { background: #252525; }
        .control-group { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 6px; }

        /* SETTINGS MENU */
        #settings-menu { display: none; position: absolute; top: 55px; right: 10px; background: var(--bg-sidebar); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); flex-direction: column; gap: 12px; min-width: 280px; z-index: 100; max-height: 80vh; overflow-y: auto; }
        #settings-menu.active { display: flex; }

        /* EDITOR MODAL */
        #editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; }
        .modal-content { background: var(--bg-sidebar); padding: 20px; border-radius: 12px; width: 95%; max-width: 700px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); box-sizing: border-box; }
        .editor-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
        .modal-content label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: var(--accent-blue); margin-top: 10px; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-body); color: var(--text-main); font-family: 'Courier New', monospace; box-sizing: border-box; }

        /* SONG DISPLAY */
        #song-capture-area { padding: 25px; background: var(--bg-song-area); color: var(--text-song); min-height: 100%; }
        .chords-container { background: rgba(128,128,128,0.1); border: 1px solid var(--border-color); padding: 15px; margin: 15px 0; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; }
        .lyrics-content { white-space: pre-wrap; font-size: var(--lyrics-font-size); line-height: 1.6; }
        .inline-chord { font-weight: bold; color: var(--text-chords); cursor: pointer; }

        /* UTILS */
        .btn-icon { border: none; background: transparent; font-size: 18px; padding: 5px 8px; cursor: pointer; color: var(--text-main); }
        #song-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #song-list li { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #song-list li.selected { background: var(--accent-blue); color: white; }
        .fav-star { color: #ccc; transition: 0.2s; padding: 5px; }
        .fav-star.active { color: #ffc107; }
        .connection-dot { display:inline-block; width:10px; height:10px; border-radius:50%; background:red; margin-right:5px; }
        .connected { background: #28a745; }
        #progress-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:white; z-index:2100; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="progress-overlay">
    <h2>Eksport...</h2><p id="progress-count">0/0</p>
</div>

<div id="editor-modal">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0;">üìù Edytor Piosenki</h3>
        <div class="editor-grid">
            <div><label>TYTU≈Å</label><input type="text" id="edit-title"></div>
            <div><label>BPM</label><input type="number" id="edit-bpm" placeholder="120"></div>
        </div>
        <label>WYKONAWCA / TAGI (male/female)</label>
        <input type="text" id="edit-artist">
        <label>AKORDY (Wstƒôp / Samodzielne)</label>
        <textarea id="edit-chords" style="height:50px;"></textarea>
        <label>TEKST (Akordy w nawiasach [C])</label>
        <textarea id="edit-lyrics" style="height:200px;"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="closeEditor()" style="flex:1; padding:12px;">Anuluj</button>
            <button onclick="saveSongData()" style="flex:1; padding:12px; background:var(--accent-success); color:white; border:none; font-weight:bold;">ZAPISZ</button>
        </div>
    </div>
</div>

<div id="app-container">
    <div id="sidebar">
        <div class="sidebar-header">
            <select id="collection-select" style="flex-grow:1; padding:10px; font-weight:bold;">
                <option value="piosenki.json">üìÅ Piosenki</option>
                <option value="koledy.json">üéÑ Kolƒôdy</option>
                <option value="lukasz.json">üë§ Moje</option>
                <option value="favorites">‚≠ê Ulubione</option>
            </select>
            <button class="btn-icon" onclick="openSettings(event)"><i class="fas fa-cog"></i></button>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button onclick="setSearch('male')" style="flex:1; font-size:11px; padding:5px;">‚ôÇ Mƒôski</button>
            <button onclick="setSearch('female')" style="flex:1; font-size:11px; padding:5px;">‚ôÄ ≈ªe≈Ñski</button>
            <button onclick="setSearch('')" style="flex:1; font-size:11px; padding:5px;">All</button>
        </div>
        <input type="text" id="search" placeholder="Szukaj..." style="width:100%; padding:12px; border-radius:20px; border:1px solid var(--border-color); box-sizing:border-box; margin-bottom:10px;">
        <ul id="song-list"></ul>
    </div>

    <div id="main-content">
        <div id="controls-bar">
            <button onclick="backToList()" class="btn-icon"><i class="fas fa-arrow-left"></i></button>
            <div class="control-group">
                <button onclick="changeTrans(-1)" class="btn-icon"><i class="fas fa-minus"></i></button>
                <span id="transpose-val" onclick="resetTrans()" style="font-weight:bold; min-width:30px; text-align:center; cursor:pointer;">0</span>
                <button onclick="changeTrans(1)" class="btn-icon"><i class="fas fa-plus"></i></button>
            </div>
            <div class="control-group">
                <button id="btn-scroll-toggle" onclick="toggleScroll()" class="btn-icon"><i class="fas fa-play"></i></button>
                <input type="range" id="scroll-speed" min="1" max="50" value="10" style="width:50px;">
            </div>
            <button onclick="toggleMetronome()" id="btn-metro-toggle" class="btn-icon"><i class="fas fa-drum"></i></button>
            <div style="flex-grow:1"></div>
            <button class="btn-icon" onclick="openSettings(event)"><i class="fas fa-cog"></i></button>
        </div>

        <div id="settings-menu">
            <div style="font-size:12px; font-weight:bold;">Tempo (BPM): <span id="bpm-val">120</span></div>
            <input type="range" id="bpm-slider" min="40" max="240" value="120" oninput="setBPM(this.value)">
            <hr style="opacity:0.2">
            <div style="font-size:12px; font-weight:bold;">Czcionka: <span id="font-size-val">18px</span></div>
            <input type="range" id="font-size-slider" min="12" max="60" value="18" oninput="setFontSize(this.value)">
            <button onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Tryb nocny</button>
            <button onclick="toggleChordStyle()" id="btn-chord-style">Styl: Polski (H)</button>
            
            <div style="border:1px solid var(--border-color); padding:10px; border-radius:6px; margin-top:5px;">
                <div style="font-size:10px; font-weight:bold;"><span id="conn-dot" class="connection-dot"></span> SYNCHRONIZACJA</div>
                <input type="text" id="mqtt-room" placeholder="Pok√≥j" style="width:100%; margin:5px 0; padding:5px;">
                <div style="display:flex; gap:5px;">
                    <button onclick="connectMQTT(true)" style="flex:1; font-size:10px;">LIDER</button>
                    <button onclick="connectMQTT(false)" style="flex:1; font-size:10px;">S≈ÅUCHACZ</button>
                </div>
            </div>

            <button onclick="startEditCurrent()">Edytuj</button>
            <button onclick="startNewSong()">Dodaj nowƒÖ</button>
            <button onclick="exportJSON()">Pobierz JSON</button>
            <button onclick="exportAllJPG()" style="background:var(--accent-success); color:white;">Eksport JPG</button>
            <button onclick="resetFromServer()" style="background:#dc3545; color:white;">Reset Serwer</button>
        </div>

        <div id="song-capture-area">
            <div id="song-display" style="padding:40px; text-align:center; color:#888;">Wybierz piosenkƒô...</div>
        </div>
    </div>
</div>

<script>
    const SCALE = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    let allSongs = [], currentLibrary = "piosenki.json", favorites = JSON.parse(localStorage.getItem('favSongs') || '[]');
    let currentId = null, transpose = 0, chordStyle = 'PL', currentBPM = 120, currentFontSize = 18;
    let scrollInterval = null, isScrolling = false, metroInterval = null, isMetroActive = false;
    let mqttClient = null, isMaster = false, mqttTopic = "";

    // START
    document.addEventListener('DOMContentLoaded', () => {
        const sel = document.getElementById('collection-select');
        switchLibrary(sel.value);
        sel.onchange = (e) => switchLibrary(e.target.value);
        document.getElementById('search').oninput = renderList;
        document.addEventListener('click', () => document.getElementById('settings-menu').classList.remove('active'));
        document.getElementById('settings-menu').onclick = (e) => e.stopPropagation();
    });

    // BIBLIOTEKI
    async function switchLibrary(lib) {
        currentLibrary = lib;
        if (lib === "favorites") {
            const all = [];
            ["piosenki.json", "koledy.json", "lukasz.json"].forEach(k => {
                const data = JSON.parse(localStorage.getItem('db_' + k) || '[]');
                all.push(...data);
            });
            allSongs = all.filter(s => favorites.includes(s.id));
            renderList();
        } else {
            const saved = localStorage.getItem('db_' + lib);
            if (saved) { allSongs = JSON.parse(saved); renderList(); } 
            else { await loadFromServer(lib); }
        }
    }

    async function loadFromServer(file) {
        try {
            const res = await fetch(file);
            const data = await res.json();
            allSongs = data.map((s, i) => ({ ...s, id: file + "_" + i }));
            saveToLocal(); renderList();
        } catch (e) { console.error(e); }
    }

    function saveToLocal() { if(currentLibrary !== "favorites") localStorage.setItem('db_' + currentLibrary, JSON.stringify(allSongs)); }

    // RENDER LISTY
    function renderList() {
        const term = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('song-list');
        let filtered = allSongs.filter(s => {
            const txt = (s.title + " " + (s.artist||"")).toLowerCase();
            if(term === 'male' || term === 'female') return (s.artist||"").toLowerCase().includes(term);
            return txt.includes(term);
        });
        list.innerHTML = filtered.sort((a,b)=>a.title.localeCompare(b.title)).map(s => `
            <li onclick="selectSong('${s.id}')" class="${currentId === s.id ? 'selected' : ''}">
                <span>${s.title}</span>
                <i class="fas fa-star fav-star ${favorites.includes(s.id) ? 'active' : ''}" onclick="toggleFav(event, '${s.id}')"></i>
            </li>
        `).join('');
    }

    // WYB√ìR PIOSENKI
    function selectSong(id, fromSync = false) {
        currentId = id; if(!fromSync) transpose = 0;
        const song = allSongs.find(s => s.id === id);
        if(song && song.bpm) setBPM(song.bpm);
        document.getElementById('controls-bar').style.display = "flex";
        document.body.classList.add('song-active');
        updateView(); renderList();
        document.getElementById('main-content').scrollTop = 0;
        if(!fromSync) broadcastState();
    }

    // WIDOK
    function updateView() {
        const song = allSongs.find(s => s.id === currentId);
        if (!song) return;
        let html = `<div style="text-align:center;margin-bottom:20px;"><h2>${song.title}</h2><h4>${song.artist || ''}</h4></div>`;
        if (song.chords) {
            const tc = song.chords.replace(/([a-gA-G][#b]?|[hH])/g, m => transChord(m, transpose));
            html += `<div class="chords-container">${tc}</div>`;
        }
        const lyr = (song.lyrics || "").replace(/\[(.*?)\]/g, (m, c) => `<span class="inline-chord">${transChord(c, transpose)}</span>`);
        document.getElementById('song-display').innerHTML = html + `<div class="lyrics-content">${lyr}</div>`;
        document.getElementById('transpose-val').textContent = (transpose > 0 ? '+' : '') + transpose;
    }

    function transChord(chord, steps) {
        return chord.replace(/([a-gA-G][#b]?|[hH])/g, (match) => {
            let base = match.toUpperCase();
            if (base === 'H') base = 'B';
            else if (base === 'BB') base = 'A#';
            let idx = SCALE.indexOf(base);
            if (idx === -1) return match;
            let newIdx = (idx + steps % 12 + 12) % 12;
            let res = SCALE[newIdx];
            if (chordStyle === 'PL' && res === 'B') res = 'H';
            return res;
        });
    }

    // BPM & METRONOM
    function setBPM(val) {
        currentBPM = parseInt(val);
        document.getElementById('bpm-val').textContent = currentBPM;
        document.getElementById('bpm-slider').value = currentBPM;
        if (isMetroActive) { stopMetronome(); startMetronome(); }
    }

    function toggleMetronome() { isMetroActive ? stopMetronome() : startMetronome(); }
    function startMetronome() {
        isMetroActive = true; document.getElementById('btn-metro-toggle').style.color = "#28a745";
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        metroInterval = setInterval(() => {
            const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            osc.frequency.value = 1000; g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
            osc.start(); osc.stop(ctx.currentTime + 0.1);
        }, (60 / currentBPM) * 1000);
    }
    function stopMetronome() { clearInterval(metroInterval); isMetroActive = false; document.getElementById('btn-metro-toggle').style.color = "inherit"; }

    // MQTT
    function connectMQTT(master) {
        const room = document.getElementById('mqtt-room').value;
        if(!room) return alert("Podaj kod pokoju");
        isMaster = master; mqttTopic = "muzycznik/" + room;
        if(mqttClient) mqttClient.end();
        mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        mqttClient.on('connect', () => {
            document.getElementById('conn-dot').classList.add('connected');
            if(!isMaster) mqttClient.subscribe(mqttTopic);
        });
        mqttClient.on('message', (topic, msg) => {
            if(!isMaster) {
                const data = JSON.parse(msg.toString());
                const s = allSongs.find(x => x.title === data.title);
                if(s) { transpose = data.t; selectSong(s.id, true); }
            }
        });
    }
    function broadcastState() {
        if(isMaster && mqttClient?.connected) {
            const s = allSongs.find(x => x.id === currentId);
            if(s) mqttClient.publish(mqttTopic, JSON.stringify({title: s.title, t: transpose}));
        }
    }

    // EDYTOR
    function startNewSong() { currentId = null; document.getElementById('editor-modal').style.display='flex'; }
    function startEditCurrent() {
        const s = allSongs.find(x => x.id === currentId);
        if(!s) return;
        document.getElementById('edit-title').value = s.title;
        document.getElementById('edit-bpm').value = s.bpm || 120;
        document.getElementById('edit-artist').value = s.artist || '';
        document.getElementById('edit-chords').value = s.chords || '';
        document.getElementById('edit-lyrics').value = s.lyrics || '';
        document.getElementById('editor-modal').style.display='flex';
    }
    function saveSongData() {
        const newS = {
            id: currentId || "u_" + Date.now(),
            title: document.getElementById('edit-title').value,
            bpm: document.getElementById('edit-bpm').value,
            artist: document.getElementById('edit-artist').value,
            chords: document.getElementById('edit-chords').value,
            lyrics: document.getElementById('edit-lyrics').value
        };
        if(currentId) allSongs[allSongs.findIndex(x=>x.id===currentId)] = newS;
        else allSongs.push(newS);
        saveToLocal(); renderList(); closeEditor(); selectSong(newS.id);
    }
    function closeEditor() { document.getElementById('editor-modal').style.display='none'; }

    // INNE
    function toggleScroll() {
        isScrolling = !isScrolling;
        const btn = document.getElementById('btn-scroll-toggle');
        if(isScrolling) {
            btn.innerHTML = '<i class="fas fa-pause"></i>';
            scrollInterval = setInterval(() => document.getElementById('main-content').scrollTop += 1, 105 - document.getElementById('scroll-speed').value);
        } else {
            btn.innerHTML = '<i class="fas fa-play"></i>';
            clearInterval(scrollInterval);
        }
    }
    function setFontSize(v) { currentFontSize = v; document.documentElement.style.setProperty('--lyrics-font-size', v+'px'); document.getElementById('font-size-val').textContent = v+'px'; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function toggleFav(e, id) { e.stopPropagation(); favorites.includes(id) ? favorites=favorites.filter(x=>x!==id) : favorites.push(id); localStorage.setItem('favSongs', JSON.stringify(favorites)); renderList(); }
    function backToList() { document.body.classList.remove('song-active'); stopMetronome(); }
    function changeTrans(v) { transpose += v; updateView(); broadcastState(); }
    function resetTrans() { transpose = 0; updateView(); broadcastState(); }
    function exportJSON() { const blob = new Blob([JSON.stringify(allSongs, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=currentLibrary; a.click(); }
    function openSettings(e) { e.stopPropagation(); document.getElementById('settings-menu').classList.toggle('active'); }
    async function resetFromServer() { if(confirm("Reset?")) { localStorage.removeItem('db_'+currentLibrary); await loadFromServer(currentLibrary); } }
    
    async function exportAllJPG() {
        const ov = document.getElementById('progress-overlay'); ov.style.display='flex';
        for(let i=0; i<allSongs.length; i++) {
            document.getElementById('progress-count').textContent = (i+1)+"/"+allSongs.length;
            selectSong(allSongs[i].id); await new Promise(r=>setTimeout(r,400));
            const canvas = await html2canvas(document.getElementById('song-capture-area'), {scale:2});
            const a = document.createElement('a'); a.download=allSongs[i].title+".jpg"; a.href=canvas.toDataURL("image/jpeg",0.8); a.click();
        }
        ov.style.display='none';
    }
</script>
</body>
</html>
