<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Śpiewnik Pro 2025 (Sync Fix)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f4f4f4; --bg-sidebar: #ffffff; --bg-main: #ffffff; --bg-song-area: #ffffff;
            --text-main: #333; --text-song: #000000; --text-chords: #a0522d;
            --border-color: #ccc; --accent-success: #28a745; --accent-blue: #007bff; --lyrics-font-size: 18px;
        }
        body.dark-mode {
            --bg-body: #121212; --bg-sidebar: #1e1e1e; --bg-main: #181818; --bg-song-area: #181818;
            --text-main: #e0e0e0; --text-song: #ffffff; --text-chords: #ff9f43; --border-color: #444;
        }
        body { font-family: Arial, sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; overflow: hidden; text-align: left; }
        #app-container { display: flex; height: 100vh; width: 100vw; position: relative; }
        #sidebar { width: 320px; border-right: 1px solid var(--border-color); background: var(--bg-sidebar); padding: 15px; display: flex; flex-direction: column; z-index: 20; }
        #main-content { flex-grow: 1; overflow-y: auto; background: var(--bg-main); scroll-behavior: smooth; position: relative; z-index: 10; touch-action: pan-y; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; box-sizing: border-box; transition: transform 0.3s ease; }
            #main-content { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            body.song-active #main-content { transform: translateX(0); }
            body.song-active #sidebar { transform: translateX(-100%); }
            .mobile-only { display: inline-block !important; }
        }
        .mobile-only { display: none; }

        #controls-bar { display: flex; gap: 8px; padding: 10px; background: #eee; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 30; align-items: center; }
        body.dark-mode #controls-bar { background: #252525; border-color: #444; }

        #settings-menu { display: none; position: absolute; top: 55px; right: 10px; background: var(--bg-sidebar); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); flex-direction: column; gap: 12px; min-width: 260px; z-index: 100; max-height: 80vh; overflow-y: auto; }
        #settings-menu.active { display: flex; }

        #song-capture-area { padding: 25px; background: var(--bg-song-area); color: var(--text-song); min-height: 100%; }
        .chords-container { background: rgba(128,128,128,0.1); border: 1px solid var(--border-color); padding: 15px; margin: 15px 0; border-radius: 5px; }
        #active-chords-content { font-family: 'Courier New', monospace; font-size: calc(var(--lyrics-font-size) * 0.9); white-space: pre-wrap; margin: 0; }
        .lyrics-content { white-space: pre-wrap; font-size: var(--lyrics-font-size); line-height: 1.6; }
        .inline-chord { font-weight: bold; color: var(--text-chords); }

        button { cursor: pointer; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-sidebar); color: var(--text-main); }
        #song-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #song-list li { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; }
        #song-list li.selected { background: var(--accent-blue); color: white; }
        
        .connection-dot { display:inline-block; width:10px; height:10px; border-radius:50%; background:red; margin-right:5px; }
        .connected { background: #28a745; }
    </style>
</head>
<body>

<div id="settings-menu">
    <div style="font-size:12px; font-weight:bold;">Rozmiar tekstu</div>
    <input type="range" id="font-size-slider" min="12" max="60" value="18" oninput="setFontSize(this.value)">
    <button onclick="toggleChordsDisplay()">Ukryj/Pokaż akordy</button>
    <button onclick="toggleDarkMode()">Tryb nocny</button>
    
    <div style="border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; margin-top: 10px;">
        <div style="font-size: 11px; font-weight: bold;"><span id="conn-status-dot" class="connection-dot"></span> SYNCHRONIZACJA</div>
        <input type="text" id="mqtt-room-code" placeholder="Hasło zespołu" style="width:100%; margin: 5px 0; padding:5px; box-sizing: border-box;">
        <div style="display:flex; gap:5px;">
            <button onclick="connectMQTT(true)" style="flex:1; background:#007bff; color:white;">LIDER</button>
            <button onclick="connectMQTT(false)" style="flex:1;">SŁUCHACZ</button>
        </div>
        <div id="mqtt-status-text" style="font-size:10px; color:green; margin-top:5px;"></div>
    </div>
    <button onclick="exportJSON()">Pobierz bazę (JSON)</button>
    <button onclick="resetFromServer()" style="color:red;">Resetuj bazę</button>
</div>

<div id="app-container">
    <div id="sidebar">
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <select id="collection-select" style="flex-grow:1; padding:8px;">
                <option value="piosenki.json">Główna</option>
                <option value="koledy.json">Kolędy</option>
                <option value="lukasz.json">Inne</option>
                <option value="favorites">⭐ Ulubione</option>
            </select>
            <button onclick="openSettings(event)"><i class="fas fa-cog"></i></button>
        </div>
        <input type="text" id="search" placeholder="Szukaj..." style="padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;">
        <ul id="song-list"></ul>
    </div>

    <div id="main-content">
        <div id="controls-bar" style="display:none;">
            <button onclick="backToList()" class="mobile-only">Lista</button>
            <button onclick="changeTrans(-1)">-1</button>
            <span id="transpose-val" style="font-weight:bold; min-width:20px; text-align:center;">0</span>
            <button onclick="changeTrans(1)">+1</button>
            <button onclick="toggleScroll()" id="btn-scroll-toggle"><i class="fas fa-play"></i></button>
            <div style="flex-grow:1"></div>
            <button onclick="openSettings(event)"><i class="fas fa-cog"></i></button>
        </div>
        <div id="song-capture-area">
            <div id="song-display" style="padding:40px; text-align:center; color:#999;">Wybierz piosenkę</div>
        </div>
    </div>
</div>

<script>
    const dScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'B', 'H'];
    let allSongs = [], currentLibrary = "piosenki.json", favorites = JSON.parse(localStorage.getItem('favSongs') || '[]');
    let currentId = null, transpose = 0, showChords = true, currentFontSize = 18;
    let mqttClient = null, isMaster = false, mqttTopic = "";

    document.addEventListener('DOMContentLoaded', () => {
        const sel = document.getElementById('collection-select');
        switchLibrary(sel.value);
        sel.onchange = (e) => switchLibrary(e.target.value);
        document.getElementById('search').oninput = renderList;
        document.getElementById('settings-menu').addEventListener('click', e => e.stopPropagation());
        if(localStorage.getItem('mqttRoom')) document.getElementById('mqtt-room-code').value = localStorage.getItem('mqttRoom');
    });

    async function switchLibrary(lib) {
        currentLibrary = lib;
        const saved = localStorage.getItem('db_' + lib);
        if (saved) { allSongs = JSON.parse(saved); renderList(); } 
        else { await loadFromServer(lib); }
    }

    async function loadFromServer(fileName) {
        try {
            const res = await fetch(fileName);
            const data = await res.json();
            allSongs = data.map((s, i) => ({ ...s, id: fileName + "_" + i }));
            localStorage.setItem('db_' + fileName, JSON.stringify(allSongs));
            renderList();
        } catch (e) { console.log("Brak pliku na serwerze"); }
    }

    function renderList() {
        const term = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('song-list');
        list.innerHTML = allSongs.filter(s => s.title.toLowerCase().includes(term)).map(s => `
            <li onclick="selectSong('${s.id}')" class="${currentId === s.id ? 'selected' : ''}">
                <b>${s.title}</b><span>${s.artist || ''}</span>
            </li>
        `).join('');
    }

    function selectSong(id, fromSync = false) {
        currentId = id;
        if(!fromSync) transpose = 0;
        document.getElementById('controls-bar').style.display = "flex";
        document.body.classList.add('song-active');
        updateView();
        renderList();
        if(!fromSync) broadcastState();
    }

    function updateView() {
        const song = allSongs.find(s => s.id === currentId);
        if (!song) return;
        let html = `<div style="text-align:center"><h2>${song.title}</h2><h4>${song.artist || ''}</h4></div>`;
        if (song.chords && showChords) {
            const tc = song.chords.replace(/([A-GHa-gh][b#]?[\w\d]*)/g, m => transChord(m, transpose));
            html += `<div class="chords-container"><pre id="active-chords-content">${tc}</pre></div>`;
        }
        const lyr = (song.lyrics || "").replace(/\[(.*?)\]/g, showChords ? (m, c) => `<span class="inline-chord">${transChord(c, transpose)}</span>` : '');
        document.getElementById('song-display').innerHTML = html + `<div class="lyrics-content">${lyr}</div>`;
        document.getElementById('transpose-val').textContent = transpose;
    }

    function transChord(c, s) {
        return c.replace(/[A-GHa-gh][b#]?/, b => {
            let base = b.toUpperCase();
            let i = dScale.indexOf(base);
            if (i === -1) return b;
            return dScale[(i + s % 12 + 12) % 12];
        });
    }

    function changeTrans(v) { transpose += v; updateView(); broadcastState(); }
    function setFontSize(v) { currentFontSize = v; document.documentElement.style.setProperty('--lyrics-font-size', v + 'px'); }
    function openSettings(e) { e.stopPropagation(); document.getElementById('settings-menu').classList.toggle('active'); }
    function backToList() { document.body.classList.remove('song-active'); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function toggleChordsDisplay() { showChords = !showChords; updateView(); }

    document.addEventListener('click', () => document.getElementById('settings-menu').classList.remove('active'));

    // --- SYNCHRONIZACJA PO TYTULE (MQTT) ---
    function connectMQTT(master) {
        const room = document.getElementById('mqtt-room-code').value.trim();
        if(!room) return alert("Podaj hasło!");
        isMaster = master;
        mqttTopic = "spiewnik_pro_2025/" + room;
        
        if(mqttClient) mqttClient.end();
        mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

        mqttClient.on('connect', () => {
            document.getElementById('conn-status-dot').classList.add('connected');
            document.getElementById('mqtt-status-text').textContent = isMaster ? "LIDER AKTYWNY" : "SŁUCHACZ AKTYWNY";
            if(!isMaster) mqttClient.subscribe(mqttTopic);
        });

        mqttClient.on('message', (topic, msg) => {
            if(!isMaster) {
                const data = JSON.parse(msg.toString());
                // Szukaj piosenki po tytule zamiast po ID
                const found = allSongs.find(s => s.title === data.title);
                if(found) {
                    transpose = data.t;
                    selectSong(found.id, true);
                }
            }
        });
    }

    function broadcastState() {
        if(isMaster && mqttClient && mqttClient.connected) {
            const song = allSongs.find(s => s.id === currentId);
            if(song) {
                mqttClient.publish(mqttTopic, JSON.stringify({
                    title: song.title,
                    t: transpose
                }), { retain: true });
            }
        }
    }

    function exportJSON() {
        const b = new Blob([JSON.stringify(allSongs)], {type:"application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "spiewnik.json"; a.click();
    }
</script>
</body>
</html>
