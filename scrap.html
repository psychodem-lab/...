<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Song Scraper Pro (Resumable)</title>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f172a; color: #f8fafc; max-width: 850px; margin: 30px auto; padding: 20px; }
        .app-card { background: #1e293b; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); border: 1px solid #334155; }
        h1 { font-size: 1.5rem; color: #38bdf8; margin-top: 0; }
        .input-group { margin-bottom: 1rem; }
        label { display: block; font-size: 0.85rem; color: #94a3b8; margin-bottom: 6px; }
        input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; box-sizing: border-box; }
        .button-group { display: flex; gap: 10px; margin-top: 1.5rem; flex-wrap: wrap; }
        button { flex: 1; min-width: 150px; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        #scrapBtn { background: #38bdf8; color: #0f172a; }
        #scrapBtn:disabled { background: #475569; cursor: not-allowed; }
        #downloadBtn { background: #22c55e; color: white; display: none; }
        #retryBtn { background: #f59e0b; color: white; display: none; }
        .progress-box { margin-top: 1.5rem; display: none; }
        .bar-bg { background: #334155; height: 14px; border-radius: 7px; overflow: hidden; }
        #bar-fill { width: 0%; height: 100%; background: #38bdf8; transition: width 0.3s; }
        #status-text { font-size: 13px; text-align: center; margin-top: 8px; color: #94a3b8; }
        #console { background: #000; border-radius: 8px; padding: 15px; font-family: 'Consolas', monospace; font-size: 11px; height: 200px; overflow-y: auto; margin-top: 1.5rem; border: 1px solid #334155; color: #10b981; line-height: 1.5; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>

<div class="app-card">
    <h1>üéµ Song Scraper Pro <span style="font-size: 0.7rem; color: #94a3b8;">v2.1 (Error Recovery)</span></h1>
    
    <div class="input-group">
        <label>URL ≈öpiewnika / Kategorii:</label>
        <input type="text" id="targetUrl" value="http://spiewnik.autodetekcja.pl/category/na-swieta/">
    </div>

    <div class="input-group">
        <label>Filtr wykonawcy:</label>
        <input type="text" id="artistFilter" placeholder="np. Perfect">
    </div>
    
    <div class="button-group">
        <button id="scrapBtn" onclick="initScraping()">ROZPOCZNIJ SCRAPOWANIE</button>
        <button id="retryBtn" onclick="runScraper()">SPR√ìBUJ PONOWNIE (Wzn√≥w)</button>
        <button id="downloadBtn" onclick="saveJson()">POBIERZ JSON (Niepe≈Çny/Pe≈Çny)</button>
    </div>

    <div class="progress-box" id="pBox">
        <div class="bar-bg"><div id="bar-fill"></div></div>
        <div id="status-text">Czekam...</div>
    </div>

    <div id="console">System gotowy. Wprowad≈∫ URL.</div>
</div>

<script>
    let songs = [];
    let pendingLinks = [];
    let currentLinkIndex = 0;
    
    const PROXY_LIST = [
        { name: "AllOrigins", url: "https://api.allorigins.win/get?url=", type: "json" },
        { name: "Codetabs", url: "https://api.codetabs.com/v1/proxy?quest=", type: "text" },
        { name: "ThingProxy", url: "https://thingproxy.freeboard.io/fetch/", type: "text" }
    ];

    function print(msg, type = 'log') {
        const c = document.getElementById('console');
        const div = document.createElement('div');
        if (type === 'error') div.className = 'error';
        if (type === 'warning') div.className = 'warning';
        div.innerText = `> ${msg}`;
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }

    async function fetchWithFailover(targetUrl) {
        for (let proxy of PROXY_LIST) {
            try {
                const finalUrl = proxy.url + encodeURIComponent(targetUrl);
                const response = await fetch(finalUrl);
                if (!response.ok) throw new Error();
                if (proxy.type === "json") {
                    const data = await response.json();
                    if (data.contents) return data.contents;
                } else {
                    return await response.text();
                }
            } catch (err) {
                continue; 
            }
        }
        throw new Error("B≈ÇƒÖd po≈ÇƒÖczenia");
    }

    function findLinks(html, base) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const links = [];
        const domain = new URL(base).hostname;
        doc.querySelectorAll('h2.entry-title a, article a').forEach(a => {
            try {
                const url = new URL(a.href, base).href;
                if (url.includes(domain) && !url.includes('/category/') && !url.includes('/tag/') && url.length > base.length) {
                    if (!links.includes(url)) links.push(url);
                }
            } catch(e) {}
        });
        return links;
    }

    function parseSong(html, id) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const titleTag = doc.querySelector('.entry-title, h1');
        if (!titleTag) return null;
        const fullTitle = titleTag.innerText.trim();
        const parts = fullTitle.split('‚Äì');
        const title = parts[0].trim();
        const artist = parts[1] ? parts[1].trim() : "Nieznany";
        const contentDiv = doc.querySelector('.entry-content');
        if (!contentDiv) return null;
        const rawText = contentDiv.innerText;
        const chordRegex = /\b[A-Ga-g][b#]?(m|maj|min|dim|aug|sus|7|6|4|2|add9)?\b/g;
        const chords = [...new Set(rawText.match(chordRegex))].sort().join(" ");
        let formatted = rawText.replace(/\b([A-Ga-g][b#]?(m|maj|min|dim|aug|sus|7|6|4|2|add9)?)\.?\b/g, "[$1]");
        return { id: `song_${id}`, title, artist, chords, lyrics: formatted.trim() };
    }

    async function initScraping() {
        const url = document.getElementById('targetUrl').value;
        if(!url) return alert("Podaj URL!");
        
        // Resetowanie danych
        songs = [];
        pendingLinks = [];
        currentLinkIndex = 0;
        document.getElementById('console').innerText = "";
        document.getElementById('retryBtn').style.display = "none";
        document.getElementById('downloadBtn').style.display = "none";
        document.getElementById('scrapBtn').disabled = true;
        document.getElementById('pBox').style.display = "block";

        print("Pobieranie listy piosenek...");
        try {
            const indexHtml = await fetchWithFailover(url);
            pendingLinks = findLinks(indexHtml, url);
            if(pendingLinks.length === 0) throw new Error("Brak link√≥w.");
            print(`Znaleziono ${pendingLinks.length} utwor√≥w.`);
            runScraper();
        } catch (e) {
            print("Nie uda≈Ço siƒô pobraƒá listy piosenek. Sprawd≈∫ URL lub bramki proxy.", "error");
            document.getElementById('scrapBtn').disabled = false;
        }
    }

    async function runScraper() {
        document.getElementById('retryBtn').style.display = "none";
        document.getElementById('scrapBtn').disabled = true;
        const filter = document.getElementById('artistFilter').value.toLowerCase().trim();

        for (let i = currentLinkIndex; i < pendingLinks.length; i++) {
            currentLinkIndex = i; // Zapisujemy postƒôp
            const progress = ((i + 1) / pendingLinks.length) * 100;
            document.getElementById('bar-fill').style.width = progress + "%";
            document.getElementById('status-text').innerText = `Postƒôp: ${i + 1}/${pendingLinks.length} (Zebrano: ${songs.length})`;

            try {
                const sHtml = await fetchWithFailover(pendingLinks[i]);
                const song = parseSong(sHtml, i);
                if (song) {
                    if (filter === "" || song.artist.toLowerCase().includes(filter)) {
                        songs.push(song);
                        print(`DODANO: ${song.title}`);
                    }
                }
                await new Promise(r => setTimeout(r, 600));
            } catch (e) {
                print(`B≈ÅƒÑD KRYTYCZNY przy: ${pendingLinks[i]}`, "error");
                print("Co chcesz zrobiƒá? Mo≈ºesz pobraƒá dotychczasowe piosenki lub spr√≥bowaƒá ponownie.", "warning");
                
                // Pokazujemy opcje ratunkowe
                document.getElementById('retryBtn').style.display = "inline-block";
                document.getElementById('downloadBtn').style.display = "inline-block";
                document.getElementById('scrapBtn').disabled = false;
                return; // Zatrzymujemy pƒôtlƒô
            }
        }

        print("UKO≈ÉCZONO PROCES.", "success");
        document.getElementById('downloadBtn').style.display = "inline-block";
        document.getElementById('scrapBtn').disabled = false;
    }

    function saveJson() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(songs, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = songs.length < pendingLinks.length ? "piosenki_NIEPELNE.json" : "piosenki_PELNE.json";
        a.click();
    }
</script>

</body>
</html>
