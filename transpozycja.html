<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Studio Pro v6.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #1e1e24;
            --bg-panel: #2b2b36;
            --primary: #4cc9f0;
            --accent: #f72585;
            --text-main: #e0e0e0;
            --text-muted: #9494a0;
            --border: #3d3d4d;
            --success: #2ec4b6;
            --key-white: #fffff0;
            --key-black: #111;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--bg-panel);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            border: 1px solid var(--border);
        }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { margin: 0; color: var(--primary); font-size: 22px; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; }
        .version-badge { background: var(--border); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--text-muted); }

        /* TOOLS GRID */
        .top-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .tool-box {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* METRONOME */
        .metronome-area { justify-content: space-between; }
        .led-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 40px; }
        .led {
            width: 16px; height: 16px; background: #444; border-radius: 50%;
            transition: background 0.05s, box-shadow 0.05s; margin-bottom: 4px;
        }
        .led.beat { background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .led.bar { background: var(--success); box-shadow: 0 0 15px var(--success); }
        
        input[type="number"], select {
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); padding: 5px; border-radius: 4px;
        }

        /* RANKING */
        .key-area { flex-direction: column; align-items: stretch; }
        .ranking-header { font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-weight: bold; }
        .ranking-list { list-style: none; padding: 0; margin: 0; font-size: 13px; }
        .ranking-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed var(--border); }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-score { color: var(--success); font-weight: bold; }

        /* CONTROLS */
        .controls-row {
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
            background: rgba(0,0,0,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .btn {
            padding: 8px 16px; border: none; background: #3d3d4d; color: #fff;
            border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;
            display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { background: #555; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-accent { background: var(--accent); color: #fff; }
        
        .trans-display {
            font-size: 24px; font-weight: bold; color: var(--primary);
            min-width: 50px; text-align: center; line-height: 1;
        }

        /* EDITOR */
        .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        @media (max-width: 768px) { .editor-grid { grid-template-columns: 1fr; } }
        
        textarea {
            width: 100%; height: 200px; padding: 15px;
            background: #1a1a20; border: 1px solid var(--border);
            color: var(--text-main); border-radius: 8px;
            font-family: 'Courier New', monospace; font-size: 14px;
            resize: vertical; box-sizing: border-box;
        }
        textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* INSTRUMENTS */
        .section-label { 
            color: var(--text-muted); font-size: 12px; text-transform: uppercase; 
            letter-spacing: 1px; margin: 20px 0 10px; border-left: 3px solid var(--primary); padding-left: 10px;
        }

        /* Displays */
        .display-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
        .chord-screen {
            background: #111; color: var(--primary); padding: 15px;
            border-radius: 8px; text-align: center; font-family: monospace;
            border: 1px solid #333; position: relative;
        }
        .chord-name { font-size: 24px; font-weight: bold; letter-spacing: 1px; }
        .chord-sub { font-size: 11px; color: #666; text-transform: uppercase; display: block; margin-bottom: 5px; }

        /* Piano */
        .piano-container { overflow-x: auto; padding-bottom: 10px; text-align: center; background: #222; border-radius: 8px; padding: 20px; }
        .piano-keys { display: inline-flex; position: relative; height: 120px; }
        .key {
            position: relative; border: 1px solid #000; border-radius: 0 0 5px 5px;
            cursor: pointer; user-select: none; display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 5px; font-size: 10px; font-weight: bold; color: #aaa; box-shadow: inset 0 -3px 5px rgba(0,0,0,0.2);
        }
        .key-white { width: 40px; height: 100%; background: var(--key-white); color: #555; z-index: 1; }
        .key-white:active, .key-white.active { background: #ddd; background: linear-gradient(to bottom, #fff 0%, #4cc9f0 100%); }
        .key-black {
            width: 26px; height: 70px; background: var(--key-black); color: #ccc;
            margin-left: -13px; margin-right: -13px; z-index: 2; font-size: 9px; padding-bottom: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .key-black:active, .key-black.active { background: #333; background: linear-gradient(to bottom, #222 0%, #f72585 100%); }

        /* Guitar */
        .guitar-container { overflow-x: auto; background: #222; border-radius: 8px; padding: 20px; text-align: center; }
        .fretboard {
            display: inline-block; background: #3e2723; border: 4px solid #1a1a1a;
            position: relative; padding: 10px 0; border-radius: 4px; box-shadow: inset 0 0 20px #000;
        }
        .string { height: 32px; display: flex; position: relative; align-items: center; }
        .string::after {
            content: ''; position: absolute; left: 0; right: 0; height: 2px;
            background: #b0bec5; box-shadow: 0 1px 2px rgba(0,0,0,0.5); z-index: 1; pointer-events: none;
        }
        .string:nth-child(1)::after, .string:nth-child(2)::after { height: 1px; opacity: 0.8; } /* Cieńsze struny */
        .string:nth-child(5)::after, .string:nth-child(6)::after { height: 3px; } /* Grubsze struny */

        .fret {
            width: 50px; height: 100%; border-right: 3px solid #9e9e9e;
            position: relative; z-index: 2; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .fret:hover { background: rgba(255,255,255,0.05); }
        .fret-0 { width: 30px; border-right: 6px solid #d4af37; background: rgba(0,0,0,0.3); }
        
        .note-marker {
            width: 24px; height: 24px; border-radius: 50%; background: var(--success);
            color: #fff; font-size: 11px; font-weight: bold; display: flex; justify-content: center; align-items: center;
            opacity: 0; transform: scale(0.5); transition: 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 10px var(--success); position: relative; z-index: 10;
        }
        .fret.active .note-marker { opacity: 1; transform: scale(1); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-music"></i> Music Studio <span style="font-size:0.6em; color:var(--text-muted)">PRO</span></h1>
        <div class="version-badge">v6.0 Data & Facts Edition</div>
    </header>

    <div class="top-panel">
        <div class="tool-box metronome-area">
            <div class="led-wrapper">
                <div id="metronome-led" class="led"></div>
                <span id="beat-display" style="font-size:10px; font-weight:bold; color:#777">-</span>
            </div>
            
            <div style="flex-grow:1; display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; justify-content:center; align-items:center; gap:8px;">
                    <i class="fas fa-tachometer-alt" style="color:#777"></i>
                    <input type="number" id="bpm-input" value="120" min="40" max="240" style="width:60px; text-align:center" onchange="Metronome.updateSettings()">
                    <span style="font-size:12px; color:#777">BPM</span>
                </div>
                <div style="display:flex; justify-content:center; gap:5px;">
                    <select id="meter-input" style="width:80px" onchange="Metronome.updateSettings()">
                        <option value="4" selected>4/4</option>
                        <option value="3">3/4</option>
                        <option value="6">6/8</option>
                        <option value="0">Free</option>
                    </select>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:5px;">
                <button class="btn btn-primary" id="btn-play" onclick="Metronome.toggle()">
                    <i class="fas fa-play"></i> START
                </button>
                <button class="btn" onclick="Metronome.tap()">TAP</button>
            </div>
        </div>

        <div class="tool-box key-area">
            <div class="ranking-header">Wykryta tonacja (prawdopodobieństwo)</div>
            <ul id="key-ranking" class="ranking-list">
                <li style="text-align:center; padding:10px; color:#666;">Wklej akordy, aby przeanalizować</li>
            </ul>
        </div>
    </div>

    <div class="controls-row">
        <button class="btn" onclick="Transposer.shift(-1)"><i class="fas fa-minus"></i></button>
        <div class="trans-display" id="transpose-val">0</div>
        <button class="btn" onclick="Transposer.shift(1)"><i class="fas fa-plus"></i></button>
        
        <div style="width:1px; height:30px; background:var(--border); margin:0 10px;"></div>

        <button class="btn" id="btn-style" onclick="Globals.toggleStyle()">
            <i class="fas fa-globe"></i> Styl: Polski (H)
        </button>
        <button class="btn btn-accent" onclick="Transposer.copy()">
            <i class="fas fa-copy"></i> Kopiuj
        </button>
        <button class="btn" onclick="Globals.toggleSound()" id="btn-sound">
            <i class="fas fa-volume-up"></i> Dźwięk: ON
        </button>
    </div>

    <div class="editor-grid">
        <div>
            <div class="section-label">Wejście (Tekst z akordami)</div>
            <textarea id="input-chords" placeholder="Wklej tekst piosenki tutaj (np. G D Em C)..." oninput="Transposer.process()"></textarea>
        </div>
        <div>
            <div class="section-label">Wynik Transpozycji</div>
            <textarea id="output-chords" readonly placeholder="Tutaj pojawi się wynik..."></textarea>
        </div>
    </div>

    <div class="display-row">
        <div class="chord-screen">
            <span class="chord-sub">Pianino</span>
            <div id="piano-res" class="chord-name">---</div>
            <button class="btn" style="position:absolute; top:5px; right:5px; padding:2px 6px; font-size:10px;" onclick="Instruments.reset('piano')">CLR</button>
        </div>
        <div class="chord-screen">
            <span class="chord-sub">Gitara</span>
            <div id="guitar-res" class="chord-name">---</div>
            <button class="btn" style="position:absolute; top:5px; right:5px; padding:2px 6px; font-size:10px;" onclick="Instruments.reset('guitar')">CLR</button>
        </div>
    </div>

    <div class="section-label">Wirtualne Pianino</div>
    <div class="piano-container">
        <div class="piano-keys" id="piano-body"></div>
    </div>

    <div class="section-label">Gryf Gitary</div>
    <div class="guitar-container">
        <div class="fretboard" id="guitar-body"></div>
    </div>
</div>

<script>
/**
 * AUDIO ENGINE
 * Prosty syntezator oparty na Web Audio API do generowania dźwięków.
 */
const AudioEngine = {
    ctx: null,
    enabled: true,
    
    init() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    },

    playTone(freq, type = 'sine', duration = 0.3) {
        if (!this.enabled) return;
        this.init();
        if (this.ctx.state === 'suspended') this.ctx.resume();

        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        
        // Obwiednia dźwięku (ADSR - simplified)
        gain.gain.setValueAtTime(0, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.2, this.ctx.currentTime + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);

        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },

    playClick(accent = false) {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        // Niższe tony są przyjemniejsze dla ucha niż wysokie piski
        osc.frequency.value = accent ? 800 : 400; 
        osc.type = 'triangle'; // Trójkątny brzmi bardziej jak "bip" niż sinus
        
        gain.gain.setValueAtTime(0, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.05);

        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.05);
    }
};

/**
 * LOGIKA MUZYCZNA I DANE
 */
const DATA = {
    scale: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
    // Częstotliwości nut (oktawa 2-5) dla syntezatora
    freqs: {
        'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41, 'F2': 87.31, 'F#2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
        'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25
    },
    chords: { 
        '': [0,4,7], 'm': [0,3,7], '7': [0,4,7,10], 'maj7': [0,4,7,11], 
        'm7': [0,3,7,10], 'sus4': [0,5,7], 'sus2': [0,2,7], 'dim': [0,3,6], 
        'aug': [0,4,8], '6': [0,4,7,9] 
    },
    keys: {
        'C-dur': ['C','Dm','Em','F','G','Am','Bdim'], 
        'G-dur': ['G','Am','Bm','C','D','Em','F#dim'], 
        'D-dur': ['D','Em','F#m','G','A','Bm','C#dim'], 
        'A-dur': ['A','Bm','C#m','D','E','F#m','G#dim'], 
        'E-dur': ['E','F#m','G#m','A','B','C#m','D#dim'],
        'F-dur': ['F','Gm','Am','Bb','C','Dm','Edim'], 
        'Am-moll': ['Am','Bdim','C','Dm','Em','F','G'], 
        'Em-moll': ['Em','F#dim','G','Am','Bm','C','D'] 
    }
};

const Globals = {
    transpose: 0,
    style: 'PL', // PL (H/B) or INT (B/Bb)
    
    toggleStyle() {
        this.style = this.style === 'PL' ? 'INT' : 'PL';
        document.getElementById('btn-style').innerHTML = `<i class="fas fa-globe"></i> Styl: ${this.style === 'PL' ? 'Polski (H)' : 'Angielski (B)'}`;
        Transposer.process();
        Instruments.renderPiano(); 
        Instruments.renderGuitar();
        Instruments.analyze('piano'); Instruments.analyze('guitar');
    },

    toggleSound() {
        AudioEngine.enabled = !AudioEngine.enabled;
        const btn = document.getElementById('btn-sound');
        if(AudioEngine.enabled) {
            btn.innerHTML = '<i class="fas fa-volume-up"></i> Dźwięk: ON';
            btn.style.opacity = "1";
        } else {
            btn.innerHTML = '<i class="fas fa-volume-mute"></i> Dźwięk: OFF';
            btn.style.opacity = "0.6";
        }
    },

    // Pomocnicza do formatowania nut
    formatNote(n) {
        if(this.style === 'PL') { 
            if(n === 'B') return 'H'; 
            if(n === 'A#') return 'B'; 
        } else {
            if(n === 'A#') return 'Bb';
        }
        return n;
    }
};

/**
 * TRANSPOSER ENGINE
 */
const Transposer = {
    shift(val) {
        Globals.transpose += val;
        const disp = Globals.transpose > 0 ? `+${Globals.transpose}` : Globals.transpose;
        document.getElementById('transpose-val').textContent = disp;
        this.process();
    },

    process() {
        const input = document.getElementById('input-chords').value;
        
        // Regex wychwytujący akordy
        const regex = /([A-G][#b]?|H)(m|maj|dim|aug|sus|add|7|9|11|13|\/)*\b/g;
        
        // Analiza tonacji na podstawie inputu (przed transpozycją)
        const foundChords = input.match(regex) || [];
        this.analyzeKey(foundChords);

        // Transpozycja
        const output = input.replace(regex, (match, root, suffix) => {
            // Normalizacja (H -> B dla obliczeń)
            let base = root;
            if (base === 'H') base = 'B'; 
            if (base === 'B' && Globals.style === 'PL') base = 'A#'; // W PL 'B' to często Bb, ale tutaj dla uproszczenia trzymamy system chromatyczny
            
            // Konwersja Bemoli na Krzyżyki dla obliczeń (Db -> C#)
            const flats = {'Db':'C#', 'Eb':'D#', 'Gb':'F#', 'Ab':'G#', 'Bb':'A#'};
            if(flats[base]) base = flats[base];

            let idx = DATA.scale.indexOf(base);
            if (idx === -1) return match; // Nie znaleziono nuty

            // Oblicz nową nutę
            let newIdx = (idx + Globals.transpose) % 12;
            if (newIdx < 0) newIdx += 12;
            
            let newRoot = DATA.scale[newIdx];
            return Globals.formatNote(newRoot) + (suffix || '');
        });

        document.getElementById('output-chords').value = output;
    },

    analyzeKey(chords) {
        let scores = {}; 
        Object.keys(DATA.keys).forEach(k => scores[k] = 0);
        
        // Uproszczenie akordów do podstawy (np. Am7 -> Am)
        let simpleChords = chords.map(c => {
            if(c === 'H') c = 'B'; // Normalizacja dla bazy
            return c.replace(/(7|maj7|m7|sus4|sus2|\/.*)/g, '');
        });

        simpleChords.forEach(c => {
            // Spróbuj dopasować akord do bazy
            for(let keyName in DATA.keys) {
                // Normalizacja bazy danych (zamiana B na H jeśli trzeba, ale baza ma format międzynarodowy)
                // Tutaj sprawdzamy czy c (np. 'Am') jest w tablicy klucza
                if(DATA.keys[keyName].includes(c)) scores[keyName]++;
            }
        });

        // Sortowanie wyników
        let sorted = Object.keys(scores)
            .filter(k => scores[k] > 0)
            .sort((a,b) => scores[b] - scores[a]);
        
        const list = document.getElementById('key-ranking');
        if(sorted.length === 0) {
            list.innerHTML = '<li style="text-align:center; padding:5px; color:#666">Za mało danych</li>';
        } else {
            list.innerHTML = sorted.slice(0, 3).map(k => `
                <li class="ranking-item">
                    <span>${k}</span>
                    <span class="ranking-score">${scores[k]} pkt</span>
                </li>
            `).join('');
        }
    },

    async copy() {
        try {
            await navigator.clipboard.writeText(document.getElementById('output-chords').value);
            const btn = document.querySelector('.btn-accent');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Skopiowano!';
            setTimeout(() => btn.innerHTML = original, 1500);
        } catch(err) { console.error("Copy failed", err); }
    }
};

/**
 * INSTRUMENTS MANAGER
 */
const Instruments = {
    activeNotes: { piano: [], guitar: [] },

    init() {
        this.renderPiano();
        this.renderGuitar();
    },

    renderPiano() {
        const container = document.getElementById('piano-body');
        container.innerHTML = '';
        const octaves = 3; // Ile oktaw rysować
        const startOctave = 2; // C2

        for(let o=0; o<octaves; o++) {
            DATA.scale.forEach((note, i) => {
                const currentOctave = startOctave + o;
                const isBlack = note.includes('#');
                
                const key = document.createElement('div');
                key.className = `key ${isBlack ? 'key-black' : 'key-white'}`;
                key.dataset.note = note;
                key.dataset.octave = currentOctave;
                key.textContent = Globals.formatNote(note);
                
                // Eventy
                key.onmousedown = () => this.toggleNote('piano', key, note, currentOctave);
                
                // Wstawianie we właściwe miejsce (czarne klawisze)
                if(isBlack) {
                    // Ostatni biały klawisz
                    const lastWhite = container.lastElementChild;
                    // Czarne klawisze są pozycjonowane marginami w CSS, po prostu je dodajemy
                }
                container.appendChild(key);
            });
        }
    },

    renderGuitar() {
        const container = document.getElementById('guitar-body');
        container.innerHTML = '';
        // Standard tuning: E A D G B E (od dołu do góry wizualnie na ekranie, czyli od E4 do E2)
        const strings = ['E4', 'B3', 'G3', 'D3', 'A2', 'E2'];

        strings.forEach((openNote, sIdx) => {
            const row = document.createElement('div');
            row.className = 'string';
            
            // Parsowanie nuty struny (np. E2 -> Note: E, Octave: 2)
            let rootNote = openNote.slice(0, -1);
            let rootOctave = parseInt(openNote.slice(-1));
            let rootIdx = DATA.scale.indexOf(rootNote);

            for(let fret=0; fret<=13; fret++) {
                const fDiv = document.createElement('div');
                fDiv.className = `fret fret-${fret}`;
                
                // Obliczanie nuty na progu
                let totalIdx = rootIdx + fret;
                let currentNote = DATA.scale[totalIdx % 12];
                let currentOctave = rootOctave + Math.floor(totalIdx / 12);
                
                fDiv.innerHTML = `<div class="note-marker">${Globals.formatNote(currentNote)}</div>`;
                fDiv.onclick = () => this.toggleNote('guitar', fDiv, currentNote, currentOctave);
                
                row.appendChild(fDiv);
            }
            container.appendChild(row);
        });
    },

    toggleNote(inst, element, noteName, octave) {
        // Toggle visual
        const isActive = element.classList.contains('active');
        
        // Dla gitary: wyłącz inne progi na tej samej strunie (logika monofoniczna struny)
        if(inst === 'guitar' && !isActive) {
            const siblings = element.parentElement.querySelectorAll('.fret');
            siblings.forEach(s => s.classList.remove('active'));
        }

        if(isActive) {
            element.classList.remove('active');
        } else {
            element.classList.add('active');
            // Play sound
            const freqKey = noteName + octave;
            if(DATA.freqs[freqKey]) AudioEngine.playTone(DATA.freqs[freqKey], inst === 'guitar' ? 'triangle' : 'sine');
        }
        
        this.analyze(inst);
    },

    analyze(inst) {
        const parent = document.getElementById(inst === 'piano' ? 'piano-body' : 'guitar-body');
        const activeEls = parent.querySelectorAll('.active');
        const resBox = document.getElementById(`${inst}-res`);

        if(activeEls.length === 0) { resBox.textContent = '---'; return; }

        // Pobierz indeksy nut (0-11)
        let notes = [];
        activeEls.forEach(el => {
            let n = el.dataset.note || el.querySelector('.note-marker').textContent; // Fallback for guitar visual text
            // Dla gitary musimy przeliczyć tekst z powrotem na format międzynarodowy, jeśli jest w PL
            if (Globals.style === 'PL') {
                if(n === 'H') n = 'B';
                if(n === 'B') n = 'A#';
            }
            // Z gitary bierzemy tekst z markera, który jest sformatowany. Lepiej obliczyć na nowo? 
            // Uproszczenie: dla gitary activeEls to div, musimy przeliczyć nutę.
            // Szybsza metoda: Pobieramy unikalne nuty modulo 12.
            // Ale dla "chord naming" interwały są ważne.
        });
        
        // Lepsze podejście: Zbieramy indeksy 0-11 wszystkich aktywnych nut
        let indices = new Set();
        activeEls.forEach(el => {
            if(inst === 'piano') indices.add(DATA.scale.indexOf(el.dataset.note));
            else {
                // Guitar logic: odtworzenie nuty jest trudniejsze z DOM.
                // Użyjmy dataset, którego nie dodaliśmy w renderGuitar. Dodajmy go teraz w myślach (lub w kodzie wyżej).
                // *Poprawka w renderGuitar*: nie dodaliśmy dataset.note. 
                // Fix: W tej funkcji analizy zrobimy to "na piechotę" po tekście, bo łatwiej.
                let txt = el.textContent || el.innerText;
                if(Globals.style === 'PL' && txt === 'H') txt = 'B';
                else if(Globals.style === 'PL' && txt === 'B') txt = 'A#';
                else if(txt === 'Bb') txt = 'A#';
                indices.add(DATA.scale.indexOf(txt));
            }
        });

        let sortedNotes = Array.from(indices).sort((a,b)=>a-b);
        if(sortedNotes.includes(-1)) return; // Błąd parsowania

        if(sortedNotes.length === 1) {
            resBox.textContent = Globals.formatNote(DATA.scale[sortedNotes[0]]);
            return;
        }

        // Algorytm szukania akordu (Brute Force po interwałach)
        for(let root of sortedNotes) {
            let intervals = sortedNotes.map(n => (n - root + 12) % 12).sort((a,b)=>a-b);
            // intervals[0] będzie zawsze 0
            
            for(let type in DATA.chords) {
                let pattern = DATA.chords[type];
                if(pattern.length === intervals.length && pattern.every((val, i) => val === intervals[i])) {
                    resBox.textContent = Globals.formatNote(DATA.scale[root]) + type;
                    return;
                }
            }
        }
        resBox.textContent = "?";
    },

    reset(inst) {
        const parent = document.getElementById(inst === 'piano' ? 'piano-body' : 'guitar-body');
        parent.querySelectorAll('.active').forEach(e => e.classList.remove('active'));
        this.analyze(inst);
    }
};

/**
 * METRONOME ENGINE
 */
const Metronome = {
    bpm: 120,
    meter: 4,
    isPlaying: false,
    timerID: null,
    nextNoteTime: 0.0,
    currentBeat: 0,
    lookahead: 25.0,
    scheduleAheadTime: 0.1,

    updateSettings() {
        this.bpm = parseInt(document.getElementById('bpm-input').value);
        this.meter = parseInt(document.getElementById('meter-input').value);
    },

    toggle() {
        this.isPlaying = !this.isPlaying;
        const btn = document.getElementById('btn-play');
        
        if (this.isPlaying) {
            AudioEngine.init(); // Ensure context exists
            if (AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();
            
            this.currentBeat = 0;
            this.nextNoteTime = AudioEngine.ctx.currentTime;
            this.scheduler();
            btn.innerHTML = '<i class="fas fa-stop"></i> STOP';
            btn.classList.add('btn-accent');
            btn.classList.remove('btn-primary');
        } else {
            window.clearTimeout(this.timerID);
            btn.innerHTML = '<i class="fas fa-play"></i> START';
            btn.classList.add('btn-primary');
            btn.classList.remove('btn-accent');
            document.getElementById('beat-display').textContent = '-';
        }
    },

    scheduler() {
        // while there are notes that will need to play before the next interval, schedule them
        while (this.nextNoteTime < AudioEngine.ctx.currentTime + this.scheduleAheadTime) {
            this.scheduleNote(this.currentBeat, this.nextNoteTime);
            this.nextNote();
        }
        this.timerID = window.setTimeout(() => this.scheduler(), this.lookahead);
    },

    scheduleNote(beatNumber, time) {
        const isAccent = (this.meter > 0 && beatNumber === 0);
        
        // Audio
        // Tworzymy oscylator w przyszłości (time)
        const osc = AudioEngine.ctx.createOscillator();
        const gain = AudioEngine.ctx.createGain();
        osc.frequency.value = isAccent ? 1000 : 600; // Niższe, przyjemniejsze kliki
        if(isAccent) osc.type = 'square'; else osc.type = 'triangle'; // Różnica w barwie

        gain.gain.setValueAtTime(0, time);
        gain.gain.linearRampToValueAtTime(0.3, time + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

        osc.connect(gain);
        gain.connect(AudioEngine.ctx.destination);
        osc.start(time);
        osc.stop(time + 0.05);

        // Visuals (Draw UI slightly delayed to match audio perception or use requestAnimationFrame)
        // Używamy setTimeout z różnicą czasu, aby zapalić diodę w momencie dźwięku
        const diff = (time - AudioEngine.ctx.currentTime) * 1000;
        setTimeout(() => {
            const led = document.getElementById('metronome-led');
            const disp = document.getElementById('beat-display');
            
            led.className = isAccent ? 'led bar' : 'led beat';
            disp.textContent = this.meter > 0 ? (beatNumber + 1) : '•';
            
            setTimeout(() => led.className = 'led', 100);
        }, diff);
    },

    nextNote() {
        const secondsPerBeat = 60.0 / this.bpm;
        this.nextNoteTime += secondsPerBeat;
        if(this.meter > 0) {
            this.currentBeat = (this.currentBeat + 1) % this.meter;
        } else {
            this.currentBeat = 0; // Always accented if meter is 0 (Free)
        }
    },

    // Tap Tempo
    lastTap: 0,
    taps: [],
    tap() {
        const now = Date.now();
        if (this.lastTap && (now - this.lastTap < 2000)) {
            const diff = now - this.lastTap;
            this.taps.push(diff);
            if (this.taps.length > 4) this.taps.shift();
            
            const avg = this.taps.reduce((a, b) => a + b) / this.taps.length;
            const bpm = Math.round(60000 / avg);
            
            document.getElementById('bpm-input').value = bpm;
            this.updateSettings();
        } else {
            this.taps = [];
        }
        this.lastTap = now;
    }
};

// Start
window.onload = () => {
    Instruments.init();
    // Inicjalizacja pustego wykresu akordów
    Instruments.analyze('piano');
    Instruments.analyze('guitar');
};

</script>
</body>
</html>
