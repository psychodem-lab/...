<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Studio v5.1 - Full Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #007bff; --success: #28a745; --bg: #f4f7f9; --card-bg: #ffffff;
            --text: #333; --border: #dee2e6; --danger: #dc3545; --accent: #00d4ff;
            --key-bg: #f3f0ff; --key-text: #6f42c1; --guitar-wood: #3d2b1f; --fret-color: #c0c0c0;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1150px; background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 15px; }
        h1 { margin: 0; color: var(--primary); font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }

        /* TOP PANEL */
        .top-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .tool-box { background: #f8f9fa; border: 1px solid var(--border); padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 12px; }
        .metronome-area { justify-content: space-between; }
        .led-group { display: flex; flex-direction: column; align-items: center; min-width: 45px; }
        .led { width: 20px; height: 20px; background: #ddd; border-radius: 50%; transition: 0.05s; }
        .led.active { background: var(--danger); box-shadow: 0 0 12px var(--danger); }
        .led.accent { background: var(--accent); box-shadow: 0 0 12px var(--accent); }
        .key-area { background: var(--key-bg); border-color: #d1c4e9; color: var(--key-text); flex-direction: column; align-items: flex-start; }
        .ranking-list { width: 100%; margin-top: 5px; font-size: 12px; list-style: none; padding: 0; }
        .ranking-item { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px dashed rgba(111, 66, 193, 0.2); }

        /* CONTROLS */
        .controls-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; background: #eee; padding: 8px; border-radius: 10px; }
        .btn { padding: 7px 12px; border: 1px solid var(--border); background: white; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; font-size: 12px; transition: 0.2s; }
        .btn:hover { background: #eee; }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }

        /* EDITOR */
        .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        textarea { width: 100%; height: 200px; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: 'Courier New', monospace; font-size: 14px; background: #fafafa; box-sizing: border-box; resize: none; line-height: 1.4; }

        /* INSTRUMENT DISPLAYS */
        .display-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0 10px; }
        .inst-display { background: #222; color: var(--primary); padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; border: 2px solid #444; }
        .inst-display span { color: #fff; display: block; font-size: 0.65em; text-transform: uppercase; margin-bottom: 4px; opacity: 0.7; }

        /* PIANO */
        .piano-wrap { overflow-x: auto; white-space: nowrap; padding: 10px 0; text-align: center; }
        .octave { display: inline-block; position: relative; height: 100px; }
        .white-key, .black-key { display: inline-block; border: 1px solid #888; cursor: pointer; float: left; border-radius: 0 0 4px 4px; font-size: 10px; font-weight: bold; align-items: flex-end; display: flex; justify-content: center; padding-bottom: 4px; }
        .white-key { width: 34px; height: 100px; background: white; color: #555; }
        .black-key { width: 22px; height: 60px; background: #222; margin: 0 -11px; z-index: 2; color: #eee; font-size: 8px; }
        .piano-active { background: var(--primary) !important; color: white !important; }

        /* GUITAR */
        .guitar-wrap { text-align: center; margin-top: 10px; }
        .guitar-neck { display: inline-block; background: var(--guitar-wood); border: 2px solid #222; border-radius: 4px; padding: 5px 0; overflow-x: auto; max-width: 100%; }
        .string { height: 28px; display: flex; align-items: center; position: relative; }
        .string::before { content: ""; position: absolute; width: 100%; height: 2px; background: #999; z-index: 1; }
        .fret { width: 55px; height: 100%; border-right: 2px solid #c0c0c0; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 2; position: relative; }
        .fret-0 { width: 35px; border-right: 5px solid #e5c100; background: rgba(0,0,0,0.4); }
        .note-dot { width: 22px; height: 22px; border-radius: 50%; background: rgba(0,0,0,0.5); color: #fff; font-size: 10px; font-weight: bold; display: flex; justify-content: center; align-items: center; opacity: 0.6; }
        .guitar-active .note-dot { background: var(--success) !important; color: white !important; opacity: 1; box-shadow: 0 0 8px var(--success); }
        
        .inst-label { font-weight: bold; color: #666; font-size: 11px; text-transform: uppercase; margin: 15px 0 5px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <header><h1>Muzyczny Scyzoryk v5.1</h1></header>

    <div class="top-panel">
        <div class="tool-box metronome-area">
            <div class="led-group"><div id="metronome-led" class="led"></div><span id="beat-num" style="font-size:11px; font-weight:bold;">-</span></div>
            <div style="display:flex; gap:5px; align-items: center;">
                <input type="number" id="bpm-input" value="120" style="width:50px; height: 25px;" onchange="updateBpm()">
                <select id="meter-input" onchange="updateMeter()"><option value="0">Brak</option><option value="3">3/4</option><option value="4" selected>4/4</option><option value="6">6/8</option></select>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn" id="btn-metronome" onclick="toggleMetronome()"><i class="fas fa-play"></i></button>
                <button class="btn" onclick="tapTempo()">TAP</button>
            </div>
        </div>
        <div class="tool-box key-area">
            <div style="font-weight:bold; font-size:13px;">Ranking Tonacji:</div>
            <ul id="key-ranking" class="ranking-list"><li>Czekam na dane...</li></ul>
        </div>
    </div>

    <div class="controls-row">
        <button class="btn" onclick="changeTrans(-1)"><i class="fas fa-minus"></i></button>
        <span id="transpose-val" style="font-weight:bold; font-size:20px; min-width:40px; text-align:center;">0</span>
        <button class="btn" onclick="changeTrans(1)"><i class="fas fa-plus"></i></button>
        <button class="btn" id="btn-style" onclick="toggleStyle()">Styl: Polski (H)</button>
        <button class="btn btn-success" onclick="copyResult()">Kopiuj wynik</button>
    </div>

    <div class="editor-grid">
        <div><textarea id="input-chords" placeholder="Wklej tekst z akordami..." oninput="process()"></textarea></div>
        <div><textarea id="output-chords" readonly placeholder="Wynik transpozycji..."></textarea></div>
    </div>

    <div class="display-row">
        <div class="inst-display"><span>Pianino</span><div id="piano-res">---</div><button class="btn" style="font-size:9px; margin:5px auto 0;" onclick="clearPiano()">Reset</button></div>
        <div class="inst-display"><span>Gitara</span><div id="guitar-res">---</div><button class="btn" style="font-size:9px; margin:5px auto 0;" onclick="clearGuitar()">Reset</button></div>
    </div>

    <div class="inst-label">Pianino</div>
    <div class="piano-wrap"><div id="piano-body"></div></div>

    <div class="inst-label">Gitara</div>
    <div class="guitar-wrap"><div class="guitar-neck" id="guitar-body"></div></div>
</div>

<script>
    const SCALE = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const CHORD_DATA = { '': [0,4,7], 'm': [0,3,7], '7': [0,4,7,10], 'maj7': [0,4,7,11], 'm7': [0,3,7,10], 'sus4': [0,5,7], 'sus2': [0,2,7], 'dim': [0,3,6], 'aug': [0,4,8], '6': [0,4,7,9] };
    const KEYS_DB = { 'C-dur': ['C','Dm','Em','F','G','Am','Bdim'], 'G-dur': ['G','Am','Bm','C','D','Em','F#dim'], 'D-dur': ['D','Em','F#m','G','A','Bm','C#dim'], 'A-dur': ['A','Bm','C#m','D','E','F#m','G#dim'], 'F-dur': ['F','Gm','Am','Bb','C','Dm','Edim'], 'Am-moll': ['Am','Bdim','C','Dm','Em','F','G'], 'Em-moll': ['Em','F#dim','G','Am','Bm','C','D'] };

    let transpose = 0;
    let chordStyle = 'PL';

    function init() {
        renderPiano();
        renderGuitar();
    }

    // --- RENDEROWANIE Z NAZWAMI ---
    function renderPiano() {
        const pb = document.getElementById('piano-body'); pb.innerHTML = '';
        const pat = [1,0,1,0,1,1,0,1,0,1,0,1];
        for(let o=2; o<=4; o++) {
            const oct = document.createElement('div'); oct.className = 'octave';
            SCALE.forEach((n, i) => {
                const k = document.createElement('div'); k.className = pat[i] ? 'white-key' : 'black-key';
                k.dataset.note = n; k.textContent = formatN(n);
                k.onclick = () => {
                    k.classList.toggle('piano-active');
                    analyze('piano');
                };
                oct.appendChild(k);
            });
            pb.appendChild(oct);
        }
    }

    function renderGuitar() {
        const gb = document.getElementById('guitar-body'); gb.innerHTML = '';
        ['E4','B3','G3','D3','A2','E2'].forEach((root, sIdx) => {
            const str = document.createElement('div'); str.className = 'string';
            let rIdx = SCALE.indexOf(root.replace(/\d/,''));
            for(let f=0; f<=12; f++) {
                const fret = document.createElement('div'); fret.className = `fret fret-${f}`;
                let noteName = SCALE[(rIdx + f) % 12];
                fret.dataset.note = noteName;
                fret.innerHTML = `<div class="note-dot">${formatN(noteName)}</div>`;
                fret.onclick = () => {
                    const was = fret.classList.contains('guitar-active');
                    str.querySelectorAll('.fret').forEach(el => el.classList.remove('guitar-active'));
                    if(!was) fret.classList.add('guitar-active');
                    analyze('guitar');
                };
                str.appendChild(fret);
            }
            gb.appendChild(str);
        });
    }

    // --- ANALIZA I STYL ---
    function formatN(n) {
        if(chordStyle === 'PL') { if(n==='B') return 'H'; if(n==='A#') return 'B'; }
        else { if(n==='A#') return 'Bb'; }
        return n;
    }

    function analyze(inst) {
        const active = document.querySelectorAll(`.${inst}-active`);
        const resDisp = document.getElementById(`${inst}-res`);
        if(!active.length) { resDisp.textContent = "---"; return; }
        let notes = [...new Set(Array.from(active).map(el => SCALE.indexOf(el.dataset.note)))].sort((a,b)=>a-b);
        if(notes.length === 1) { resDisp.textContent = formatN(SCALE[notes[0]]); return; }

        for(let root of notes) {
            let intervals = notes.map(n => (n - root + 12) % 12).sort((a,b)=>a-b);
            for(let name in CHORD_DATA) {
                if(intervals.length === CHORD_DATA[name].length && intervals.every((v,i) => v === CHORD_DATA[name][i])) {
                    resDisp.textContent = formatN(SCALE[root]) + name;
                    return;
                }
            }
        }
        resDisp.textContent = "???";
    }

    function toggleStyle() { 
        chordStyle = chordStyle === 'PL' ? 'EN' : 'PL';
        document.getElementById('btn-style').textContent = `Styl: ${chordStyle === 'PL' ? 'Polski (H)' : 'Angielski (B)'}`;
        renderPiano(); renderGuitar(); process(); analyze('piano'); analyze('guitar');
    }

    // --- TRANSPOZYCJA ---
    function changeTrans(v) { transpose += v; document.getElementById('transpose-val').textContent = (transpose > 0 ? '+' : '') + transpose; process(); }

    function process() {
        const inp = document.getElementById('input-chords').value;
        const reg = /([a-gA-G][#b]?[\w\d\/#\-]*|[hH][\w\d\/#\-]*)/g;
        const found = inp.match(reg) || [];
        updateRanking(found);
        document.getElementById('output-chords').value = inp.replace(reg, m => {
            return m.replace(/([a-gA-G][#b]?|[hH])/g, x => {
                const low = x === x.toLowerCase(); let b = x.toUpperCase();
                if(b==='H') b='B'; else if(b==='B' && chordStyle==='PL') b='A#';
                let idx = SCALE.indexOf(b); if(idx === -1) return x;
                let nIdx = (idx + transpose % 12 + 12) % 12; let res = SCALE[nIdx];
                if(chordStyle==='PL') { if(res==='B') res='H'; else if(res==='A#') res='B'; }
                return low ? res.toLowerCase() : res;
            });
        });
    }

    function updateRanking(chords) {
        let scores = {}; Object.keys(KEYS_DB).forEach(k => scores[k] = 0);
        chords.forEach(c => {
            let cl = c.replace(/(7|maj7|m7|sus4)/g, '').split('/')[0];
            if(c.includes('m') && !cl.endsWith('m')) cl += 'm';
            for(let k in KEYS_DB) if(KEYS_DB[k].includes(cl)) scores[k]++;
        });
        let sorted = Object.keys(scores).filter(k => scores[k]>0).sort((a,b) => scores[b]-scores[a]);
        document.getElementById('key-ranking').innerHTML = sorted.slice(0,3).map(k => `<li class="ranking-item"><span>${k}</span><span>${scores[k]} pkt</span></li>`).join('') || '<li>Wklej tekst...</li>';
    }

    function clearPiano() { document.querySelectorAll('.piano-active').forEach(e => e.classList.remove('piano-active')); analyze('piano'); }
    function clearGuitar() { document.querySelectorAll('.guitar-active').forEach(e => e.classList.remove('guitar-active')); analyze('guitar'); }
    async function copyResult() { await navigator.clipboard.writeText(document.getElementById('output-chords').value); }

    // --- METRONOM & TAP TEMPO ---
    let audioCtx, isPlaying = false, nextTime = 0, bpm = 120, meter = 4, beat = 0, timer;
    let lastTap = 0, taps = [];

    function tapTempo() {
        const now = Date.now();
        if (lastTap > 0 && (now - lastTap) < 2000) {
            taps.push(now - lastTap); if(taps.length > 4) taps.shift();
            bpm = Math.round(60000 / (taps.reduce((a,b) => a+b) / taps.length));
            document.getElementById('bpm-input').value = bpm;
        } else { taps = []; }
        lastTap = now;
    }

    function updateBpm() { bpm = parseInt(document.getElementById('bpm-input').value) || 120; }
    function updateMeter() { meter = parseInt(document.getElementById('meter-input').value); beat = 0; }
    function toggleMetronome() {
        isPlaying = !isPlaying;
        if(isPlaying) {
            if(!audioCtx) audioCtx = new AudioContext();
            nextTime = audioCtx.currentTime; runMet();
            document.getElementById('btn-metronome').innerHTML = '<i class="fas fa-stop"></i>';
        } else {
            clearTimeout(timer); document.getElementById('btn-metronome').innerHTML = '<i class="fas fa-play"></i>';
            document.getElementById('beat-num').textContent = '-';
        }
    }
    function runMet() {
        while(nextTime < audioCtx.currentTime + 0.1) {
            let acc = (meter > 0 && beat === 0);
            const osc = audioCtx.createOscillator(), env = audioCtx.createGain();
            osc.frequency.value = acc ? 1200 : 800; env.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            osc.connect(env); env.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            const led = document.getElementById('metronome-led');
            led.className = acc ? 'led accent' : 'led active'; setTimeout(() => led.className = 'led', 60);
            document.getElementById('beat-num').textContent = meter > 0 ? (beat + 1) : 'â€¢';
            nextTime += 60/bpm; if(meter > 0) beat = (beat + 1) % meter;
        }
        timer = setTimeout(runMet, 25);
    }

    window.onload = init;
</script>
</body>
</html>
