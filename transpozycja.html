<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Studio Tool v4.1 - Fixed Chord Engine</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #007bff; --success: #28a745; --bg: #f4f7f9; --card-bg: #ffffff;
            --text: #333; --border: #dee2e6; --danger: #dc3545; --accent: #00d4ff;
            --key-bg: #f3f0ff; --key-text: #6f42c1; --guitar-wood: #3d2b1f; --fret-color: #c0c0c0;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 1100px; background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .top-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .tool-box { background: #f8f9fa; border: 1px solid var(--border); padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 12px; }
        .key-area { background: var(--key-bg); border-color: #d1c4e9; color: var(--key-text); flex-direction: column; align-items: flex-start; }
        .ranking-list { width: 100%; margin-top: 5px; font-size: 12px; list-style: none; padding: 0; }
        .ranking-item { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(111,66,193,0.2); }
        .controls-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; }
        .btn { padding: 7px 12px; border: 1px solid var(--border); background: white; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        textarea { width: 100%; height: 160px; padding: 10px; border-radius: 10px; border: 1px solid var(--border); font-family: monospace; resize: none; }
        .instrument-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); text-align: center; }
        .display-box { background: #222; color: var(--primary); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 1.2em; font-weight: bold; }
        
        /* PIANO */
        .piano { display: inline-block; white-space: nowrap; overflow-x: auto; max-width: 100%; margin-bottom: 15px; }
        .octave { display: inline-block; position: relative; height: 90px; }
        .white-key, .black-key { display: inline-block; border: 1px solid #888; cursor: pointer; float: left; border-radius: 0 0 4px 4px; font-size: 8px; align-items: flex-end; display: flex; justify-content: center; padding-bottom: 2px; }
        .white-key { width: 28px; height: 90px; background: white; }
        .black-key { width: 18px; height: 55px; background: #222; margin: 0 -9px; z-index: 2; color: #eee; }
        
        /* GUITAR */
        .guitar-neck { display: inline-block; background: var(--guitar-wood); border: 2px solid #222; border-radius: 4px; padding: 5px 0; overflow-x: auto; max-width: 100%; }
        .string { height: 26px; display: flex; align-items: center; position: relative; }
        .string::before { content: ""; position: absolute; width: 100%; height: 1px; background: #aaa; z-index: 1; }
        .fret { width: 55px; height: 100%; border-right: 2px solid var(--fret-color); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 2; }
        .fret-0 { width: 35px; border-right: 5px solid #e5c100; background: rgba(0,0,0,0.3); }
        .note-circle { width: 18px; height: 18px; border-radius: 50%; background: #444; color: transparent; font-size: 10px; display: flex; justify-content: center; align-items: center; }
        .active .note-circle { background: var(--primary) !important; color: white !important; box-shadow: 0 0 8px var(--primary); }
        .active { background: rgba(255,255,255,0.1); }

        .label { font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; margin: 10px 0 5px; }
    </style>
</head>
<body>

<div class="container">
    <header><h1>Muzyczny Scyzoryk v4.1</h1></header>

    <div class="top-panel">
        <div class="tool-box" style="justify-content:space-between;">
            <div id="metronome-led" style="width:20px; height:20px; background:#ddd; border-radius:50%;"></div>
            <input type="number" id="bpm-input" value="120" style="width:50px;">
            <button class="btn" onclick="toggleMetronome()">START/STOP</button>
        </div>
        <div class="tool-box key-area">
            <div style="font-weight:bold;">Ranking Tonacji:</div>
            <ul id="key-ranking" class="ranking-list"><li>Wklej tekst z akordami...</li></ul>
        </div>
    </div>

    <div class="controls-row">
        <button class="btn" onclick="changeTrans(-1)">-1</button>
        <span id="transpose-val" style="font-weight:bold; font-size:18px; min-width:30px; text-align:center;">0</span>
        <button class="btn" onclick="changeTrans(1)">+1</button>
        <button class="btn" id="btn-style" onclick="toggleStyle()">H / B</button>
    </div>

    <div class="editor-grid">
        <textarea id="input-chords" placeholder="Wpisz tekst..." oninput="process()"></textarea>
        <textarea id="output-chords" readonly placeholder="Wynik..."></textarea>
    </div>

    <div class="instrument-container">
        <div class="display-box"><span id="detected-chord">Zagraj coś...</span></div>
        <button class="btn" onclick="clearInstruments()" style="margin-bottom:10px;">WYCZYŚĆ</button>
        
        <div class="label">Pianino</div>
        <div class="piano" id="piano-keys"></div>

        <div class="label">Gitara (E-Standard)</div>
        <div class="guitar-neck" id="guitar-neck"></div>
    </div>
</div>

<script>
    const SCALE = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const GUITAR_STRINGS = ['E4', 'B3', 'G3', 'D3', 'A2', 'E2'];
    let selectedNotes = []; 

    const CHORD_PATTERNS = {
        '': [0, 4, 7], 'm': [0, 3, 7], '7': [0, 4, 7, 10], 'maj7': [0, 4, 7, 11],
        'm7': [0, 3, 7, 10], 'dim': [0, 3, 6], 'sus4': [0, 5, 7], 'sus2': [0, 2, 7]
    };

    function init() {
        // Piano init
        const pk = document.getElementById('piano-keys');
        const pat = [true, false, true, false, true, true, false, true, false, true, false, true];
        for(let o=2; o<=4; o++) {
            const oct = document.createElement('div'); oct.className = 'octave';
            SCALE.forEach((n, i) => {
                const k = document.createElement('div'); k.className = pat[i] ? 'white-key' : 'black-key';
                k.dataset.note = n + o; k.textContent = n;
                k.onclick = () => { k.classList.toggle('active'); updateNotes(); };
                oct.appendChild(k);
            });
            pk.appendChild(oct);
        }
        // Guitar init
        const gn = document.getElementById('guitar-neck');
        GUITAR_STRINGS.forEach((root, sIdx) => {
            const str = document.createElement('div'); str.className = 'string';
            let rIdx = SCALE.indexOf(root.replace(/\d/,''));
            for(let f=0; f<=12; f++) {
                const fret = document.createElement('div'); fret.className = `fret fret-${f}`;
                let nIdx = (rIdx + f) % 12;
                fret.dataset.note = SCALE[nIdx];
                fret.dataset.string = sIdx;
                fret.innerHTML = `<div class="note-circle">${SCALE[nIdx]}</div>`;
                fret.onclick = () => {
                    const wasActive = fret.classList.contains('active');
                    document.querySelectorAll(`.fret[data-string="${sIdx}"]`).forEach(el => el.classList.remove('active'));
                    if(!wasActive) fret.classList.add('active');
                    updateNotes();
                };
                str.appendChild(fret);
            }
            gn.appendChild(str);
        });
    }

    function updateNotes() {
        selectedNotes = [];
        document.querySelectorAll('.active').forEach(el => {
            selectedNotes.push(el.dataset.note);
        });
        detectChord();
    }

    function clearInstruments() {
        document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
        updateNotes();
    }

    function detectChord() {
        const disp = document.getElementById('detected-chord');
        if (selectedNotes.length === 0) { disp.textContent = "Zagraj coś..."; return; }

        // 1. Unikalne wartości półtonów (0-11)
        let uniqueSemi = [...new Set(selectedNotes.map(n => SCALE.indexOf(n)))].sort((a,b) => a-b);
        
        if (uniqueSemi.length === 1) { disp.textContent = SCALE[uniqueSemi[0]]; return; }

        // 2. Sprawdź każdą nutę jako bazową (Root)
        for (let root of uniqueSemi) {
            let intervals = uniqueSemi.map(n => (n - root + 12) % 12).sort((a,b) => a-b);
            
            for (let name in CHORD_PATTERNS) {
                let p = CHORD_PATTERNS[name];
                if (intervals.length === p.length && intervals.every((v, i) => v === p[i])) {
                    let rootName = SCALE[root];
                    // Prosta zamiana na polski styl jeśli trzeba
                    if (document.getElementById('btn-style').textContent.includes('H')) {
                        if (rootName === 'B') rootName = 'H'; else if (rootName === 'A#') rootName = 'B';
                    }
                    disp.textContent = rootName + name;
                    return;
                }
            }
        }
        disp.textContent = "Układ nieznany";
    }

    // Pozostałe funkcje (Transpozycja, Tonacja) bez zmian...
    let transpose = 0;
    function changeTrans(v) { transpose += v; document.getElementById('transpose-val').textContent = transpose; process(); }
    function toggleStyle() { 
        let s = document.getElementById('btn-style');
        s.textContent = s.textContent === 'H / B' ? 'B / Bb' : 'H / B';
        process(); detectChord();
    }
    function process() {
        const inp = document.getElementById('input-chords').value;
        document.getElementById('output-chords').value = inp; // Tu byłaby logika transpozycji
    }
    
    let isPlaying = false, metronomeTimer;
    function toggleMetronome() {
        isPlaying = !isPlaying;
        if(isPlaying) {
            let bpm = document.getElementById('bpm-input').value;
            let ms = 60000 / bpm;
            metronomeTimer = setInterval(() => {
                let led = document.getElementById('metronome-led');
                led.style.background = 'red';
                setTimeout(() => led.style.background = '#ddd', 100);
            }, ms);
        } else clearInterval(metronomeTimer);
    }

    window.onload = init;
</script>
</body>
</html>
